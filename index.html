<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Vocabulary Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,600;1,600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .font-serif-display {
            font-family: 'Playfair Display', serif;
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Flashcard 3D Flip Styles */
        .perspective-1000 {
            perspective: 1000px;
        }
        .transform-style-3d {
            transform-style: preserve-3d;
        }
        .backface-hidden {
            backface-visibility: hidden;
        }
        .rotate-y-180 {
            transform: rotateY(180deg);
        }
        .flashcard-inner {
            transition: transform 0.6s;
        }
        .flashcard.flipped .flashcard-inner {
            transform: rotateY(180deg);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 right-4 bg-gray-800 text-white px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full opacity-0 z-[70] flex items-center gap-2 max-w-[90vw]">
        <i class="fas fa-check-circle text-green-400 flex-shrink-0"></i>
        <span id="toast-message" class="truncate">Action successful</span>
    </div>

    <!-- Alert Modal (Custom replacement for window.alert) -->
    <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-xl max-w-sm w-full p-6 transform transition-all scale-100 animate-[fadeIn_0.2s_ease-out]">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100 mb-4">
                    <i class="fas fa-info text-indigo-600 text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-900 mb-2">Notice</h3>
                <p id="alert-message" class="text-sm text-gray-500 mb-6"></p>
                <button onclick="closeAlertModal()" class="w-full py-2.5 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal (Custom replacement for window.confirm) -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-xl max-w-sm w-full p-6 transform transition-all scale-100 animate-[fadeIn_0.2s_ease-out]">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-900 mb-2">Confirm Action</h3>
                <p id="confirm-message" class="text-sm text-gray-500 mb-6"></p>
                <div class="flex gap-3">
                    <button onclick="closeConfirmModal()" class="flex-1 py-2.5 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                        Cancel
                    </button>
                    <button id="confirm-yes-btn" class="flex-1 py-2.5 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition-colors">
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Connect Modal -->
    <div id="connect-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6 transform transition-all scale-100 animate-[fadeIn_0.2s_ease-out]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">Connect "<span id="modal-word-display" class="text-indigo-600"></span>"</h3>
                <button onclick="closeConnectModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Connect to...</label>
                    <input type="text" id="modal-conn-word" list="existing-words" placeholder="Search or type word..." class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:border-indigo-500 outline-none transition-colors">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Relationship Type</label>
                    <select id="modal-conn-type" class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:border-indigo-500 outline-none bg-white">
                         <option value="Synonym">Synonym</option>
                         <option value="Antonym">Antonym</option>
                         <option value="Noun Form">Noun Form</option>
                         <option value="Verb Form">Verb Form</option>
                         <option value="Adj Form">Adj Form</option>
                         <option value="Related">Related</option>
                    </select>
                </div>
                
                <div class="flex gap-3 mt-6 pt-2">
                    <button onclick="closeConnectModal()" class="flex-1 py-2.5 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors">Cancel</button>
                    <button onclick="saveNewConnection()" class="flex-1 py-2.5 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors shadow-md">Add Connection</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail View Modal -->
    <div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full p-6 transform transition-all scale-100 animate-[fadeIn_0.2s_ease-out] relative overflow-y-auto max-h-[90vh]">
            <button onclick="closeDetailModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded-full transition-colors"><i class="fas fa-times text-lg"></i></button>
            
            <div id="detail-content">
                <!-- Content injected via JS -->
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 min-h-[4rem] py-2 flex flex-wrap items-center justify-between gap-2">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 text-white p-2 rounded-lg shrink-0">
                    <i class="fas fa-book-open text-xl"></i>
                </div>
                <h1 class="text-xl font-bold text-gray-900 tracking-tight truncate">Vocab<span class="text-indigo-600">Master</span></h1>
            </div>
            
            <div class="flex items-center gap-3">
                <div class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full whitespace-nowrap">
                    <span id="word-count" class="font-bold text-indigo-600">0</span> <span class="hidden sm:inline">words collected</span><span class="sm:hidden">words</span>
                </div>
                <div class="h-6 w-px bg-gray-200 mx-1"></div>
                <button onclick="switchTab('settings')" class="text-gray-400 hover:text-indigo-600 transition-colors p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-200" title="Settings">
                    <i class="fas fa-cog text-xl"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8 w-full">
        
        <!-- Tab Navigation -->
        <div class="flex space-x-1 rounded-xl bg-gray-200 p-1 mb-6 sm:mb-8 overflow-x-auto">
            <button onclick="switchTab('add')" id="tab-btn-add" class="flex-1 min-w-[100px] rounded-lg py-2.5 text-sm font-medium leading-5 text-gray-600 hover:bg-white/[0.5] hover:text-indigo-600 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                <i class="fas fa-plus-circle mr-1 sm:mr-2"></i><span class="inline">Add New</span>
            </button>
            <button onclick="switchTab('list')" id="tab-btn-list" class="flex-1 min-w-[100px] rounded-lg py-2.5 text-sm font-bold leading-5 text-indigo-700 bg-white shadow ring-1 ring-black ring-opacity-5 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                <i class="fas fa-list-ul mr-1 sm:mr-2"></i><span class="inline">My List</span>
            </button>
            <button onclick="switchTab('practice')" id="tab-btn-practice" class="flex-1 min-w-[100px] rounded-lg py-2.5 text-sm font-medium leading-5 text-gray-600 hover:bg-white/[0.5] hover:text-indigo-600 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                <i class="fas fa-layer-group mr-1 sm:mr-2"></i><span class="inline">Practice</span>
            </button>
        </div>

        <!-- Tab Content: Add Word -->
        <div id="view-add" class="hidden transition-opacity duration-300 ease-in-out">
            <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100 max-w-2xl mx-auto">
                <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-feather-alt text-indigo-500"></i> New Entry
                </h2>
                
                <form id="vocab-form" class="space-y-4">
                    <!-- Word Input -->
                    <div>
                        <label for="word" class="block text-sm font-medium text-gray-700 mb-1">Word <span class="text-red-500">*</span></label>
                        <input type="text" id="word" required placeholder="e.g. Ephemeral" 
                            class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all">
                    </div>

                    <!-- Part of Speech -->
                    <div>
                        <label for="pos" class="block text-sm font-medium text-gray-700 mb-1">Part of Speech <span class="text-red-500">*</span></label>
                        <select id="pos" required 
                            class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none bg-white">
                            <option value="" disabled selected>Select type...</option>
                            <!-- Options populated by JS -->
                        </select>
                    </div>

                    <!-- Meaning -->
                    <div>
                        <label for="meaning" class="block text-sm font-medium text-gray-700 mb-1">Meaning <span class="text-red-500">*</span></label>
                        <textarea id="meaning" required rows="3" placeholder="Definition of the word..." 
                            class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all resize-none"></textarea>
                    </div>

                    <!-- Connections (New Section) -->
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Connections <span class="text-gray-400 font-normal">(Synonyms, Forms, etc.)</span></label>
                        
                        <!-- Connection Inputs -->
                        <div class="flex gap-2 mb-2">
                            <div class="relative flex-grow">
                                <input type="text" id="conn-word" list="existing-words" placeholder="Related word..." 
                                    class="w-full px-3 py-2 rounded-lg border border-gray-200 focus:border-indigo-500 outline-none text-sm">
                                <datalist id="existing-words">
                                    <!-- Populated by JS -->
                                </datalist>
                            </div>
                            <select id="conn-type" class="w-1/3 px-3 py-2 rounded-lg border border-gray-200 focus:border-indigo-500 outline-none text-sm bg-white">
                                <option value="Synonym">Synonym</option>
                                <option value="Antonym">Antonym</option>
                                <option value="Noun Form">Noun Form</option>
                                <option value="Verb Form">Verb Form</option>
                                <option value="Adj Form">Adj Form</option>
                                <option value="Related">Related</option>
                            </select>
                            <button type="button" onclick="addConnection()" class="px-3 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-colors">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>

                        <!-- Pending Connections List -->
                        <div id="pending-connections" class="flex flex-wrap gap-2 mt-2 empty:hidden">
                            <!-- JS will inject spans here -->
                        </div>
                    </div>

                    <!-- Sentence (Optional) -->
                    <div>
                        <label for="sentence" class="block text-sm font-medium text-gray-700 mb-1">Example Sentence <span class="text-gray-400 font-normal">(Optional)</span></label>
                        <textarea id="sentence" rows="2" placeholder="Use it in a sentence..." 
                            class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all resize-none"></textarea>
                    </div>

                    <!-- Tags (Optional) -->
                    <div>
                        <label for="tags" class="block text-sm font-medium text-gray-700 mb-1">Tags <span class="text-gray-400 font-normal">(Optional)</span></label>
                        <div class="relative">
                            <i class="fas fa-tag absolute left-3 top-3 text-gray-400 text-xs"></i>
                            <input type="text" id="tags" placeholder="work, difficult, travel" 
                                class="w-full pl-8 pr-4 py-2 rounded-lg border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all">
                        </div>
                        <p class="text-xs text-gray-500 mt-1 mb-2">Comma separated</p>
                        
                        <!-- Quick Tags Section -->
                        <div id="quick-tags-container" class="flex flex-wrap gap-2">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <button type="submit" 
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 rounded-lg transition-colors shadow-md hover:shadow-lg flex items-center justify-center gap-2 active:scale-95 transform">
                        <i class="fas fa-save"></i> Save to Collection
                    </button>
                </form>
            </div>
        </div>

        <!-- Tab Content: List -->
        <div id="view-list" class="space-y-6">
            
            <!-- Search Bar & Filters -->
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 flex flex-col sm:flex-row gap-4 items-center justify-between">
                <!-- Search Input -->
                <div class="relative w-full sm:flex-1 sm:min-w-[200px]">
                    <i class="fas fa-search absolute left-4 top-3.5 text-gray-400"></i>
                    <input type="text" id="search-input" placeholder="Search words..." 
                        class="w-full pl-10 pr-4 py-3 rounded-lg bg-gray-50 border-transparent focus:bg-white focus:border-indigo-300 focus:ring-2 focus:ring-indigo-200 outline-none transition-all text-base">
                </div>

                <!-- Filter Controls -->
                <div class="flex flex-wrap gap-2 w-full sm:w-auto justify-end">
                    <select id="filter-pos" class="flex-1 sm:flex-none px-4 py-3 rounded-lg bg-gray-50 border-transparent focus:bg-white focus:ring-2 focus:ring-indigo-200 outline-none text-sm text-gray-600 cursor-pointer min-w-[120px]">
                        <option value="all">All Types</option>
                        <!-- Options populated by JS -->
                    </select>
                    <select id="filter-tag" class="flex-1 sm:flex-none px-4 py-3 rounded-lg bg-gray-50 border-transparent focus:bg-white focus:ring-2 focus:ring-indigo-200 outline-none text-sm text-gray-600 cursor-pointer min-w-[120px]">
                        <option value="all">All Tags</option>
                        <!-- Options populated by JS -->
                    </select>
                    <button onclick="exportData()" class="px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg transition-colors" title="Export JSON">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="hidden flex flex-col items-center justify-center py-16 text-center bg-white rounded-2xl border border-dashed border-gray-300">
                <div class="bg-indigo-50 p-4 rounded-full mb-4">
                    <i class="fas fa-feather-alt text-3xl text-indigo-400"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-800">No words added yet</h3>
                <p class="text-gray-500 mt-2 max-w-xs">Start building your vocabulary by adding your first word in the "Add New Word" tab.</p>
            </div>

            <!-- Card Grid -->
            <div id="vocab-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                <!-- Cards will be injected here via JS -->
            </div>
        </div>

        <!-- Tab Content: Practice (Flashcards) -->
        <div id="view-practice" class="hidden w-full max-w-3xl mx-auto">
            
            <!-- Setup Screen -->
            <div id="practice-setup" class="bg-white rounded-2xl shadow-sm p-8 text-center border border-gray-100">
                <div class="bg-indigo-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-layer-group text-indigo-600 text-3xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2 font-serif-display">Flashcard Practice</h2>
                <p class="text-gray-500 mb-8">Review and memorize your vocabulary with interactive cards.</p>
                
                <div class="max-w-sm mx-auto space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2 text-left">Filter by Tag (Optional)</label>
                        <select id="practice-filter-tag" class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-indigo-500 bg-white">
                            <option value="all">All Words</option>
                            <!-- Populated by JS -->
                        </select>
                    </div>
                    
                    <div class="flex items-center justify-between bg-gray-50 p-4 rounded-lg border border-gray-100">
                        <span class="text-sm font-medium text-gray-700">Shuffle Order</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="practice-shuffle" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                        </label>
                    </div>

                    <button onclick="startPractice()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5">
                        Start Session
                    </button>
                </div>
            </div>

            <!-- Game Screen -->
            <div id="practice-game" class="hidden flex-col h-[600px]">
                
                <!-- Progress Bar -->
                <div class="flex items-center justify-between mb-6 px-2">
                    <button onclick="exitPractice()" class="text-sm text-gray-500 hover:text-gray-800 flex items-center gap-1">
                        <i class="fas fa-arrow-left"></i> Exit
                    </button>
                    <div class="text-sm font-medium text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full">
                        Card <span id="current-card-num">1</span> of <span id="total-card-num">10</span>
                    </div>
                </div>

                <!-- Flashcard Container -->
                <div class="flex-grow perspective-1000 w-full relative group">
                    <div id="flashcard" class="relative w-full h-full transform-style-3d transition-transform duration-500 cursor-pointer shadow-xl rounded-2xl" onclick="flipCard()">
                        
                        <!-- Front Face -->
                        <div class="absolute w-full h-full backface-hidden bg-white rounded-2xl border-2 border-indigo-50 flex flex-col items-center justify-center p-8 text-center">
                            <span class="text-sm uppercase tracking-widest text-gray-400 mb-4 font-semibold">Word</span>
                            <h2 id="fc-front-word" class="text-4xl sm:text-5xl font-bold text-gray-900 font-serif-display mb-4">Ephemeral</h2>
                            <span id="fc-front-pos" class="px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-600">Adjective</span>
                            
                            <div class="absolute bottom-8 text-gray-400 text-sm animate-pulse">
                                <i class="fas fa-sync-alt mr-2"></i> Click to flip
                            </div>
                        </div>

                        <!-- Back Face -->
                        <div class="absolute w-full h-full backface-hidden rotate-y-180 bg-indigo-600 text-white rounded-2xl flex flex-col items-center justify-center p-8 text-center overflow-y-auto">
                             <div class="w-full max-w-md space-y-6">
                                <div>
                                    <span class="text-xs uppercase tracking-widest text-indigo-200 font-semibold">Meaning</span>
                                    <p id="fc-back-meaning" class="text-xl sm:text-2xl font-medium mt-2 leading-relaxed">Lasting for a very short time.</p>
                                </div>

                                <div id="fc-back-sentence-container" class="hidden">
                                    <div class="h-px bg-indigo-500 w-1/3 mx-auto my-4"></div>
                                    <p id="fc-back-sentence" class="text-indigo-100 italic text-lg">"Fashions are ephemeral, changing with every season."</p>
                                </div>

                                <div id="fc-back-tags" class="flex flex-wrap justify-center gap-2 mt-4">
                                    <!-- Tags injected here -->
                                </div>
                                
                                <button onclick="event.stopPropagation(); speakWord(currentPracticeCard.word)" class="mt-4 p-3 bg-white/20 hover:bg-white/30 rounded-full transition-colors text-white">
                                    <i class="fas fa-volume-up text-lg"></i>
                                </button>
                             </div>
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="mt-8 grid grid-cols-2 gap-4">
                    <button onclick="prevCard()" class="py-3 bg-white border border-gray-200 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-colors shadow-sm">
                        <i class="fas fa-chevron-left mr-2"></i> Previous
                    </button>
                    <button onclick="nextCard()" class="py-3 bg-indigo-600 text-white rounded-xl font-medium hover:bg-indigo-700 transition-colors shadow-md">
                        Next <i class="fas fa-chevron-right ml-2"></i>
                    </button>
                </div>
                <p class="text-center text-xs text-gray-400 mt-4">Tip: Use Space to flip, Arrow keys to navigate</p>

            </div>
            
            <!-- Empty Practice State -->
            <div id="practice-empty" class="hidden bg-white rounded-2xl shadow-sm p-8 text-center border border-dashed border-gray-300">
                <div class="bg-gray-50 p-4 rounded-full inline-block mb-4">
                    <i class="fas fa-inbox text-3xl text-gray-400"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">No words found</h3>
                <p class="text-gray-500 mb-6">Add words to your list or change your filters to start practicing.</p>
                <button onclick="exitPractice()" class="text-indigo-600 hover:text-indigo-800 font-medium">Go Back</button>
            </div>
        </div>

        <!-- Tab Content: Settings -->
        <div id="view-settings" class="hidden space-y-6">
            
            <!-- Manage Tags Section -->
            <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-tags text-indigo-500"></i> Manage Saved Tags
                </h3>
                <p class="text-sm text-gray-500 mb-4">Create preset tags for quick access when adding new words.</p>
                
                <div class="flex gap-2 mb-6">
                    <input type="text" id="new-tag-input" placeholder="New tag (e.g. IELTS)" 
                        class="flex-1 px-4 py-2 rounded-lg border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all">
                    <button onclick="addNewTag()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors">
                        Add
                    </button>
                </div>

                <div id="settings-tags-list" class="flex flex-wrap gap-2">
                    <!-- JS injected chips -->
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="bg-white rounded-2xl shadow-sm p-6 border border-red-100 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1 h-full bg-red-500"></div>
                <h3 class="text-lg font-bold text-red-700 mb-2 flex items-center gap-2">
                    <i class="fas fa-exclamation-triangle"></i> Danger Zone
                </h3>
                <p class="text-gray-600 text-sm mb-6">These actions are irreversible. Proceed with caution.</p>
                
                <button onclick="clearAll()" class="w-full sm:w-auto px-6 py-3 bg-red-50 text-red-700 border border-red-200 rounded-lg font-medium hover:bg-red-100 hover:border-red-300 transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-trash-alt"></i> Delete All Vocabulary
                </button>
            </div>
        </div>

    </main>

    <footer class="bg-white border-t border-gray-200 mt-auto">
        <div class="max-w-7xl mx-auto px-4 py-6 text-center">
            <p class="text-sm text-gray-500">Saved locally in your browser.</p>
        </div>
    </footer>

    <script>
        // State Management
        const defaultTypes = ['Noun', 'Verb', 'Adjective', 'Adverb', 'Preposition', 'Conjunction', 'Idiom', 'Phrase'];
        let vocabList = JSON.parse(localStorage.getItem('vocabList')) || [];
        let savedTags = JSON.parse(localStorage.getItem('savedTags')) || ['Important', 'To Review', 'Work'];
        
        let currentConnections = []; 
        let currentEditingId = null; 
        let confirmCallback = null; 
        
        // Practice Mode State
        let practiceDeck = [];
        let practiceIndex = 0;
        let currentPracticeCard = null;

        // DOM Elements
        const form = document.getElementById('vocab-form');
        const listContainer = document.getElementById('vocab-list');
        const searchInput = document.getElementById('search-input');
        const filterPos = document.getElementById('filter-pos');
        const filterTag = document.getElementById('filter-tag');
        const emptyState = document.getElementById('empty-state');
        const wordCountSpan = document.getElementById('word-count');
        const toast = document.getElementById('toast');
        const toastMsg = document.getElementById('toast-message');
        const pendingConnContainer = document.getElementById('pending-connections');
        const datalist = document.getElementById('existing-words');
        const connectModal = document.getElementById('connect-modal');
        const detailModal = document.getElementById('detail-modal');
        const alertModal = document.getElementById('alert-modal');
        const confirmModal = document.getElementById('confirm-modal');
        const posSelect = document.getElementById('pos');
        const settingsTagsList = document.getElementById('settings-tags-list');
        const newTagInput = document.getElementById('new-tag-input');
        const quickTagsContainer = document.getElementById('quick-tags-container');
        const tagsInput = document.getElementById('tags');
        
        // Practice Elements
        const practiceSetup = document.getElementById('practice-setup');
        const practiceGame = document.getElementById('practice-game');
        const practiceEmpty = document.getElementById('practice-empty');
        const practiceFilterTag = document.getElementById('practice-filter-tag');
        const flashcard = document.getElementById('flashcard');
        const fcFrontWord = document.getElementById('fc-front-word');
        const fcFrontPos = document.getElementById('fc-front-pos');
        const fcBackMeaning = document.getElementById('fc-back-meaning');
        const fcBackSentence = document.getElementById('fc-back-sentence');
        const fcBackSentenceContainer = document.getElementById('fc-back-sentence-container');
        const fcBackTags = document.getElementById('fc-back-tags');
        const currentCardNum = document.getElementById('current-card-num');
        const totalCardNum = document.getElementById('total-card-num');


        // --- Global Modal Helpers ---
        window.showAlert = (message) => {
            document.getElementById('alert-message').textContent = message;
            alertModal.classList.remove('hidden');
        };
        window.closeAlertModal = () => {
            alertModal.classList.add('hidden');
        };

        window.showConfirm = (message, callback) => {
            document.getElementById('confirm-message').textContent = message;
            confirmCallback = callback;
            confirmModal.classList.remove('hidden');
        };
        window.closeConfirmModal = () => {
            confirmModal.classList.add('hidden');
            confirmCallback = null;
        };

        document.getElementById('confirm-yes-btn').addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            closeConfirmModal();
        });
        
        // Close Alert/Confirm on outside click
        alertModal.addEventListener('click', (e) => { if(e.target === alertModal) closeAlertModal(); });
        confirmModal.addEventListener('click', (e) => { if(e.target === confirmModal) closeConfirmModal(); });


        // Tab Switching Logic
        window.switchTab = (tabName) => {
            const views = ['add', 'list', 'settings', 'practice'];
            
            views.forEach(view => {
                const el = document.getElementById(`view-${view}`);
                const btn = document.getElementById(`tab-btn-${view}`);
                
                if (view === tabName) {
                    el.classList.remove('hidden');
                    if (btn) {
                        btn.classList.add('bg-white', 'text-indigo-700', 'shadow', 'font-bold');
                        btn.classList.remove('text-gray-600', 'font-medium', 'hover:bg-white/[0.5]');
                    }
                } else {
                    el.classList.add('hidden');
                    if (btn) {
                        btn.classList.remove('bg-white', 'text-indigo-700', 'shadow', 'font-bold');
                        btn.classList.add('text-gray-600', 'font-medium', 'hover:bg-white/[0.5]');
                    }
                }
            });
        };

        // Colors
        const posColors = {
            'Noun': 'bg-blue-100 text-blue-700 border-blue-200',
            'Verb': 'bg-green-100 text-green-700 border-green-200',
            'Adjective': 'bg-purple-100 text-purple-700 border-purple-200',
            'Adverb': 'bg-yellow-100 text-yellow-700 border-yellow-200',
            'default': 'bg-gray-100 text-gray-700 border-gray-200'
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            renderList(vocabList);
            renderPosOptions();
            renderSettingsTags();
            renderQuickTags();
            updateTagFilterOptions();
            updateDatalist();
            
            // Initialize Practice Filter
            updatePracticeFilter();
        });

        // --- Practice Mode Logic ---
        function updatePracticeFilter() {
             const allTags = new Set();
             vocabList.forEach(word => {
                if (word.tags) word.tags.forEach(tag => allTags.add(tag));
             });
             const sortedTags = Array.from(allTags).sort();
             practiceFilterTag.innerHTML = '<option value="all">All Words</option>' + 
                sortedTags.map(tag => `<option value="${tag}">#${tag}</option>`).join('');
        }

        window.startPractice = () => {
            const tagFilter = practiceFilterTag.value;
            const shouldShuffle = document.getElementById('practice-shuffle').checked;

            // Filter Deck
            practiceDeck = vocabList.filter(item => {
                if (tagFilter === 'all') return true;
                return item.tags && item.tags.includes(tagFilter);
            });

            if (practiceDeck.length === 0) {
                practiceSetup.classList.add('hidden');
                practiceEmpty.classList.remove('hidden');
                return;
            }

            // Shuffle if needed
            if (shouldShuffle) {
                practiceDeck.sort(() => Math.random() - 0.5);
            }

            practiceIndex = 0;
            practiceSetup.classList.add('hidden');
            practiceEmpty.classList.add('hidden');
            practiceGame.classList.remove('hidden');
            practiceGame.classList.add('flex');
            
            renderCard();
        };

        window.exitPractice = () => {
            practiceGame.classList.add('hidden');
            practiceGame.classList.remove('flex');
            practiceEmpty.classList.add('hidden');
            practiceSetup.classList.remove('hidden');
        };

        window.renderCard = () => {
            // Reset Flip state
            flashcard.classList.remove('flipped');
            
            // Update Data
            currentPracticeCard = practiceDeck[practiceIndex];
            
            // Front
            fcFrontWord.textContent = currentPracticeCard.word;
            fcFrontPos.textContent = currentPracticeCard.pos;
            const posClass = posColors[currentPracticeCard.pos] || posColors['default'];
            // Reset all possible color classes then add current
            fcFrontPos.className = `px-3 py-1 rounded-full text-sm font-medium border ${posClass}`;

            // Back
            // Allow a small delay to update back content so user doesn't see it change while flipping back
            setTimeout(() => {
                fcBackMeaning.textContent = currentPracticeCard.meaning;
                
                if (currentPracticeCard.sentence) {
                    fcBackSentence.textContent = `"${currentPracticeCard.sentence}"`;
                    fcBackSentenceContainer.classList.remove('hidden');
                } else {
                    fcBackSentenceContainer.classList.add('hidden');
                }

                fcBackTags.innerHTML = currentPracticeCard.tags.map(tag => 
                    `<span class="px-2 py-0.5 bg-white/20 rounded text-xs font-medium border border-white/30 text-white">#${tag}</span>`
                ).join('');
            }, 300);

            // Update Progress
            currentCardNum.textContent = practiceIndex + 1;
            totalCardNum.textContent = practiceDeck.length;
        };

        window.flipCard = () => {
            flashcard.classList.toggle('flipped');
        };

        window.nextCard = () => {
            if (practiceIndex < practiceDeck.length - 1) {
                practiceIndex++;
                renderCard();
            } else {
                // Loop back or finish? Let's loop for continuous study
                if(confirm("You've reached the end of the deck. Restart?")) {
                     practiceIndex = 0;
                     renderCard();
                }
            }
        };

        window.prevCard = () => {
            if (practiceIndex > 0) {
                practiceIndex--;
                renderCard();
            }
        };

        // Keyboard support for practice
        document.addEventListener('keydown', (e) => {
            if (!practiceGame.classList.contains('hidden')) {
                if (e.code === 'Space') {
                    e.preventDefault(); // Prevent scrolling
                    flipCard();
                } else if (e.code === 'ArrowRight') {
                    nextCard();
                } else if (e.code === 'ArrowLeft') {
                    prevCard();
                }
            }
        });


        // --- Detail View Modal ---
        window.openDetailModal = (id) => {
            const item = vocabList.find(w => w.id === id);
            if (!item) return;

            const posClass = posColors[item.pos] || posColors['default'];
            const tagsHtml = item.tags.map(tag => `<span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-full">#${tag}</span>`).join('');
            
            const connectionsHtml = (item.connections && item.connections.length > 0)
                ? `<div class="mt-6 pt-4 border-t border-gray-100">
                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Connections</h4>
                    <div class="grid grid-cols-1 gap-3">
                        ${item.connections.map(c => {
                            const linkedWord = vocabList.find(w => w.word.toLowerCase() === c.word.toLowerCase());
                            const linkedPos = linkedWord ? linkedWord.pos : 'N/A';
                            const linkedMeaning = linkedWord ? linkedWord.meaning : 'Definition not available';
                            const linkedPosStyle = linkedWord && posColors[linkedWord.pos] ? posColors[linkedWord.pos] : 'bg-gray-200 text-gray-600 border-gray-300';

                            return `
                            <div onclick="searchFor('${c.word}'); closeDetailModal();" class="flex flex-col sm:flex-row gap-2 sm:gap-4 p-3 rounded-lg bg-gray-50 border border-gray-100 hover:bg-indigo-50 hover:border-indigo-100 transition-all cursor-pointer group">
                                <div class="flex-shrink-0 sm:w-1/3">
                                    <div class="flex items-center gap-2 flex-wrap mb-1">
                                        <span class="font-bold text-gray-800 group-hover:text-indigo-700 transition-colors">${c.word}</span>
                                        <span class="text-[10px] px-1.5 py-0.5 rounded border ${linkedPosStyle}">${linkedPos}</span>
                                    </div>
                                    <div class="text-xs text-indigo-500 font-medium bg-indigo-50 inline-block px-1.5 rounded border border-indigo-100">${c.type}</div>
                                </div>
                                <div class="text-sm text-gray-600 leading-snug border-t sm:border-t-0 sm:border-l border-gray-100 sm:pl-4 pt-2 sm:pt-0 flex items-center">
                                    ${linkedMeaning}
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                   </div>`
                : '';

            const sentenceHtml = item.sentence 
                ? `<div class="mt-6 bg-gray-50 p-5 rounded-xl border-l-4 border-indigo-400 relative">
                     <i class="fas fa-quote-left absolute top-3 left-3 text-indigo-200 text-xl"></i>
                     <p class="text-gray-800 italic text-lg leading-relaxed pl-4">"${item.sentence}"</p>
                   </div>` 
                : '';

            const html = `
                <div class="pr-8">
                    <div class="flex flex-wrap items-center gap-3 mb-2">
                        <h2 class="text-3xl font-bold text-gray-900 font-serif-display">${item.word}</h2>
                        <button onclick="speakWord('${item.word.replace(/'/g, "\\'")}')" class="text-gray-400 hover:text-indigo-600 transition-colors p-2 rounded-full hover:bg-indigo-50" title="Listen">
                            <i class="fas fa-volume-up text-xl"></i>
                        </button>
                        <span class="px-3 py-1 rounded-full text-sm font-semibold border ${posClass}">${item.pos}</span>
                    </div>
                    <div class="text-gray-400 text-sm mb-4">Added on ${item.dateAdded || 'Unknown date'}</div>
                </div>

                <div class="prose text-gray-700 leading-relaxed text-lg">
                    ${item.meaning}
                </div>

                ${sentenceHtml}

                ${connectionsHtml}

                ${item.tags.length > 0 ? `<div class="mt-6 pt-4 border-t border-gray-100 flex flex-wrap gap-2">${tagsHtml}</div>` : ''}
                
                <div class="mt-8 flex justify-end gap-3 border-t border-gray-100 pt-4">
                    <button onclick="openConnectModal(${item.id}); closeDetailModal();" class="px-4 py-2 text-indigo-600 hover:bg-indigo-50 rounded-lg font-medium transition-colors flex items-center gap-2">
                        <i class="fas fa-link"></i> Connect
                    </button>
                    <button onclick="deleteWord(${item.id}); closeDetailModal();" class="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg font-medium transition-colors flex items-center gap-2">
                        <i class="fas fa-trash-alt"></i> Delete
                    </button>
                </div>
            `;

            document.getElementById('detail-content').innerHTML = html;
            detailModal.classList.remove('hidden');
        };

        window.closeDetailModal = () => {
             detailModal.classList.add('hidden');
        };
        detailModal.addEventListener('click', (e) => {
            if (e.target === detailModal) closeDetailModal();
        });

        // --- Filter Options ---
        function updateTagFilterOptions() {
            const currentSelection = filterTag.value;
            const allTags = new Set();
            savedTags.forEach(tag => allTags.add(tag));
            vocabList.forEach(word => {
                if (word.tags) word.tags.forEach(tag => allTags.add(tag));
            });
            const sortedTags = Array.from(allTags).sort();
            filterTag.innerHTML = '<option value="all">All Tags</option>' + 
                sortedTags.map(tag => `<option value="${tag}">#${tag}</option>`).join('');
            if (allTags.has(currentSelection)) filterTag.value = currentSelection;
        }

        function renderPosOptions() {
            const currentVal = posSelect.value;
            posSelect.innerHTML = '<option value="" disabled selected>Select type...</option>' + 
                defaultTypes.map(type => `<option value="${type}">${type}</option>`).join('');
            if (defaultTypes.includes(currentVal)) posSelect.value = currentVal;

            const currentFilter = filterPos.value;
            filterPos.innerHTML = '<option value="all">All Types</option>' + 
                defaultTypes.map(type => `<option value="${type}">${type}s</option>`).join('');
            filterPos.value = currentFilter;
        }

        // --- Tag Management ---
        function renderSettingsTags() {
            settingsTagsList.innerHTML = savedTags.map(tag => {
                const escapedTag = tag.replace(/'/g, "\\'");
                return `
                <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-gray-100 border border-gray-200 text-gray-700 text-sm group hover:bg-gray-200 transition-colors">
                    #${tag}
                    <button onclick="deleteSavedTag('${escapedTag}')" class="text-gray-400 hover:text-red-600 hover:bg-red-100 w-5 h-5 flex items-center justify-center rounded-full transition-colors" title="Delete Tag">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
            `}).join('');
        }

        function renderQuickTags() {
            if(savedTags.length === 0) {
                quickTagsContainer.innerHTML = '';
                return;
            }
            quickTagsContainer.innerHTML = '<span class="text-xs text-gray-400 self-center mr-1">Quick Add:</span>' + 
                savedTags.map(tag => {
                    const escapedTag = tag.replace(/'/g, "\\'");
                    return `
                    <button type="button" onclick="addTagToInput('${escapedTag}')" class="px-2 py-1 rounded-md bg-indigo-50 text-indigo-600 text-xs font-medium border border-indigo-100 hover:bg-indigo-100 transition-colors">
                        + ${tag}
                    </button>
                `}).join('');
        }

        window.addNewTag = () => {
            const val = newTagInput.value.trim();
            if (val && !savedTags.includes(val)) {
                savedTags.push(val);
                saveTags();
                renderSettingsTags();
                renderQuickTags();
                updateTagFilterOptions();
                updatePracticeFilter();
                newTagInput.value = '';
                showToast(`Added tag "${val}"`);
            } else if (savedTags.includes(val)) {
                showAlert('Tag already exists!');
            }
        };

        window.deleteSavedTag = (tag) => {
            const usageCount = vocabList.filter(word => word.tags.includes(tag)).length;
            
            showConfirm(`Remove tag preset "${tag}"?`, () => {
                // 1. Remove from Saved Tags
                savedTags = savedTags.filter(t => t !== tag);
                saveTags();
                
                // 2. Remove from words confirmation
                if (usageCount > 0) {
                    setTimeout(() => {
                        showConfirm(`This tag is used in ${usageCount} words. Remove from words too?`, () => {
                             vocabList = vocabList.map(word => {
                                if (word.tags.includes(tag)) {
                                    word.tags = word.tags.filter(t => t !== tag);
                                }
                                return word;
                            });
                            saveData();
                            renderList(vocabList);
                            showToast(`Removed tag "${tag}" everywhere`);
                        });
                    }, 300); // Small delay for nice UX
                } else {
                    showToast(`Removed tag preset "${tag}"`);
                }

                renderSettingsTags();
                renderQuickTags();
                updateTagFilterOptions();
                updatePracticeFilter();
            });
        };

        window.addTagToInput = (tag) => {
            const current = tagsInput.value.trim();
            if(current.includes(tag)) return;
            if(current.length > 0 && !current.endsWith(',')) {
                tagsInput.value = current + ', ' + tag;
            } else {
                tagsInput.value = current + tag;
            }
            tagsInput.focus();
        };

        function saveTags() {
            localStorage.setItem('savedTags', JSON.stringify(savedTags));
        }

        function updateDatalist() {
            datalist.innerHTML = vocabList.map(item => `<option value="${item.word}">`).join('');
        }

        // --- Connection Logic ---
        window.addConnection = () => {
            const wordInput = document.getElementById('conn-word');
            const typeInput = document.getElementById('conn-type');
            const word = wordInput.value.trim();
            const type = typeInput.value;

            if (!word) return;

            const exists = vocabList.some(w => w.word.toLowerCase() === word.toLowerCase());
            if (!exists) {
                showAlert(`"${word}" is not in your vocabulary list yet. Please add it first.`);
                return;
            }

            currentConnections.push({ word, type });
            renderPendingConnections();
            
            wordInput.value = '';
            wordInput.focus();
        };

        window.removeConnection = (index) => {
            currentConnections.splice(index, 1);
            renderPendingConnections();
        };

        function renderPendingConnections() {
            pendingConnContainer.innerHTML = currentConnections.map((conn, index) => `
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium bg-indigo-50 text-indigo-700 border border-indigo-100">
                    ${conn.word} <span class="opacity-50">(${conn.type})</span>
                    <button type="button" onclick="removeConnection(${index})" class="ml-1 hover:text-indigo-900"><i class="fas fa-times"></i></button>
                </span>
            `).join('');
        }

        // --- Modal Connection ---
        window.openConnectModal = (id) => {
            currentEditingId = id;
            const item = vocabList.find(w => w.id === id);
            if (!item) return;

            document.getElementById('modal-word-display').textContent = item.word;
            document.getElementById('modal-conn-word').value = '';
            connectModal.classList.remove('hidden');
            document.getElementById('modal-conn-word').focus();
        };

        window.closeConnectModal = () => {
            connectModal.classList.add('hidden');
            currentEditingId = null;
        };

        window.saveNewConnection = () => {
            if (!currentEditingId) return;
            
            const wordInput = document.getElementById('modal-conn-word');
            const typeInput = document.getElementById('modal-conn-type');
            const targetWordText = wordInput.value.trim();
            const type = typeInput.value;

            if (!targetWordText) {
                showAlert("Please enter a word to connect.");
                return;
            }

            const exists = vocabList.some(w => w.word.toLowerCase() === targetWordText.toLowerCase());
            if (!exists) {
                showAlert(`"${targetWordText}" is not in your vocabulary list yet. Please add it first.`);
                return;
            }

            const sourceIndex = vocabList.findIndex(w => w.id === currentEditingId);
            if (sourceIndex !== -1) {
                const sourceWord = vocabList[sourceIndex];

                if (!sourceWord.connections) sourceWord.connections = [];
                sourceWord.connections.push({ word: targetWordText, type: type });

                const targetIndex = vocabList.findIndex(w => w.word.toLowerCase() === targetWordText.toLowerCase());
                if (targetIndex !== -1) {
                    const targetEntry = vocabList[targetIndex];
                    if (!targetEntry.connections) targetEntry.connections = [];

                    let reverseType = 'Related';
                    if (type === 'Synonym') reverseType = 'Synonym';
                    if (type === 'Antonym') reverseType = 'Antonym';
                    if (type === 'Related') reverseType = 'Related';

                    if (!targetEntry.connections.some(c => c.word.toLowerCase() === sourceWord.word.toLowerCase())) {
                        targetEntry.connections.push({
                            word: sourceWord.word,
                            type: reverseType
                        });
                    }
                }

                saveData();
                renderList(vocabList);
                closeConnectModal();
                showToast(`Connected "${sourceWord.word}"  "${targetWordText}"`);
            }
        };

        connectModal.addEventListener('click', (e) => {
            if (e.target === connectModal) closeConnectModal();
        });

        window.searchFor = (word) => {
            switchTab('list');
            searchInput.value = word;
            filterWords();
        };

        // --- Create Word ---
        form.addEventListener('submit', (e) => {
            e.preventDefault();

            const newWordText = document.getElementById('word').value.trim();

            const newWord = {
                id: Date.now(),
                word: newWordText,
                pos: document.getElementById('pos').value,
                meaning: document.getElementById('meaning').value.trim(),
                sentence: document.getElementById('sentence').value.trim(),
                connections: [...currentConnections],
                tags: document.getElementById('tags').value.split(',').map(t => t.trim()).filter(t => t),
                dateAdded: new Date().toLocaleDateString()
            };

            if (newWord.connections && newWord.connections.length > 0) {
                newWord.connections.forEach(conn => {
                    const targetIndex = vocabList.findIndex(w => w.word.toLowerCase() === conn.word.toLowerCase());
                    
                    if (targetIndex !== -1) {
                        const targetEntry = vocabList[targetIndex];
                        if (!targetEntry.connections) targetEntry.connections = [];

                        let reverseType = 'Related';
                        if (conn.type === 'Synonym') reverseType = 'Synonym';
                        if (conn.type === 'Antonym') reverseType = 'Antonym';
                        if (conn.type === 'Related') reverseType = 'Related';

                        targetEntry.connections.push({
                            word: newWordText,
                            type: reverseType
                        });
                    }
                });
            }

            vocabList.unshift(newWord);
            saveData();
            
            form.reset();
            currentConnections = [];
            renderPendingConnections();
            updateDatalist();

            renderList(vocabList);
            showToast(`Added "${newWord.word}" successfully!`);
            
            if(window.innerWidth < 640) {
                switchTab('list');
            }
        });

        function filterWords() {
            const term = searchInput.value.toLowerCase();
            const posFilter = filterPos.value;
            const tagFilter = filterTag.value;

            const filtered = vocabList.filter(item => {
                const matchesTerm = 
                    item.word.toLowerCase().includes(term) || 
                    item.meaning.toLowerCase().includes(term) ||
                    item.tags.some(tag => tag.toLowerCase().includes(term)) ||
                    (item.connections && item.connections.some(c => c.word.toLowerCase().includes(term)));
                
                const matchesPos = posFilter === 'all' || item.pos === posFilter;
                const matchesTag = tagFilter === 'all' || item.tags.includes(tagFilter);

                return matchesTerm && matchesPos && matchesTag;
            });

            renderList(filtered);
        }

        searchInput.addEventListener('input', filterWords);
        filterPos.addEventListener('change', filterWords);
        filterTag.addEventListener('change', filterWords);

        // --- Delete Word ---
        window.deleteWord = (id) => {
            const targetId = String(id);
            
            showConfirm('Are you sure you want to delete this word?', () => {
                vocabList = vocabList.filter(w => String(w.id) !== targetId);
                saveData();
                updateDatalist();
                filterWords();
                updateTagFilterOptions();
                showToast('Word deleted');
            });
        };

        window.speakWord = (text) => {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                window.speechSynthesis.speak(utterance);
            } else {
                showToast('Text-to-speech not supported');
            }
        };

        window.copyWord = (text) => {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showToast('Word copied');
            } catch (err) {
                console.error('Unable to copy', err);
            }
            document.body.removeChild(textArea);
        };

        window.clearAll = () => {
            showConfirm('Are you sure you want to delete ALL words? This cannot be undone.', () => {
                vocabList = [];
                saveData();
                renderList(vocabList);
                updateDatalist();
                showToast('All data cleared');
            });
        }

        function saveData() {
            localStorage.setItem('vocabList', JSON.stringify(vocabList));
            updateCount();
            updateTagFilterOptions();
            updatePracticeFilter();
        }

        function updateCount() {
            wordCountSpan.textContent = vocabList.length;
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(vocabList, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "my_vocab_list.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        };

        function showToast(message) {
            toastMsg.textContent = message;
            toast.classList.remove('translate-x-full', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
            }, 3000);
        }

        function renderList(list) {
            listContainer.innerHTML = '';
            
            if (list.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            emptyState.classList.add('hidden');

            list.forEach(item => {
                const posClass = posColors[item.pos] || posColors['default'];
                const tags = item.tags || [];
                const tagsHtml = tags.length > 0 
                    ? `<div class="flex flex-wrap gap-2 mt-3 pt-3 border-t border-gray-50 pointer-events-none">
                        ${tags.map(tag => `<span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-full">#${tag}</span>`).join('')}
                       </div>` 
                    : '';

                const sentenceHtml = item.sentence 
                    ? `<div class="bg-indigo-50 p-3 rounded-lg mt-3 text-sm text-indigo-900 italic border-l-2 border-indigo-300">
                         "${item.sentence}"
                       </div>` 
                    : '';
                
                const connections = item.connections || [];
                const connectionsHtml = connections.length > 0
                    ? `<div class="flex flex-wrap gap-2 mt-3 pt-3 border-t border-gray-100">
                        <span class="text-xs text-gray-400 font-medium self-center mr-1">See also:</span>
                        ${connections.map(c => `
                            <button onclick="event.stopPropagation(); searchFor('${c.word}')" class="inline-flex items-center gap-1 px-2 py-1 rounded-md text-xs font-medium bg-gray-100 text-gray-600 hover:bg-indigo-100 hover:text-indigo-700 transition-colors border border-gray-200">
                                <i class="fas fa-link text-[10px]"></i> ${c.word} <span class="opacity-60 font-normal">(${c.type})</span>
                            </button>
                        `).join('')}
                       </div>`
                    : '';

                const card = document.createElement('div');
                card.setAttribute('onclick', `openDetailModal(${item.id})`);
                card.className = 'bg-white rounded-xl p-5 sm:p-6 shadow-sm border border-gray-100 card-hover fade-in relative group cursor-pointer';
                
                card.innerHTML = `
                    <div class="absolute top-4 right-4 opacity-100 lg:opacity-0 lg:group-hover:opacity-100 transition-opacity flex gap-1 sm:gap-2 z-20 bg-white sm:bg-transparent rounded-lg p-1 sm:p-0 shadow-sm sm:shadow-none border sm:border-0 border-gray-100">
                        <button onclick="event.stopPropagation(); speakWord('${item.word.replace(/'/g, "\\'")}')" class="p-2 text-gray-400 hover:text-green-600 hover:bg-green-50 rounded-full focus:outline-none focus:ring-2 focus:ring-green-200" title="Listen">
                            <i class="fas fa-volume-up"></i>
                        </button>
                        <button onclick="event.stopPropagation(); openConnectModal(${item.id})" class="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-200" title="Add Connection">
                            <i class="fas fa-link"></i>
                        </button>
                        <button onclick="event.stopPropagation(); copyWord('${item.word.replace(/'/g, "\\'")}')" class="p-2 text-gray-400 hover:text-indigo-600 hover:bg-gray-50 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-200" title="Copy">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button onclick="event.stopPropagation(); deleteWord('${item.id}')" class="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full focus:outline-none focus:ring-2 focus:ring-red-200" title="Delete">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>

                    <div class="flex items-baseline gap-3 mb-1 pr-32 sm:pr-36">
                        <h3 class="text-xl sm:text-2xl font-bold text-gray-900 font-serif-display tracking-wide break-words">${item.word}</h3>
                        <span class="shrink-0 px-2.5 py-0.5 rounded-full text-xs font-semibold border ${posClass}">${item.pos}</span>
                    </div>

                    <p class="text-gray-600 mt-2 leading-relaxed text-sm sm:text-base">${item.meaning}</p>
                    
                    ${connectionsHtml}
                    ${sentenceHtml}
                    ${tagsHtml}
                `;
                listContainer.appendChild(card);
            });
            
            updateCount();
        }
    </script>
</body>
</html>
