<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Vocabulary Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,600;1,600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .font-serif-display {
            font-family: 'Playfair Display', serif;
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Flashcard 3D Flip Styles */
        .perspective-1000 {
            perspective: 1000px;
        }
        .transform-style-3d {
            transform-style: preserve-3d;
        }
        .backface-hidden {
            backface-visibility: hidden;
        }
        .rotate-y-180 {
            transform: rotateY(180deg);
        }
        .flashcard-inner {
            transition: transform 0.6s;
        }
        .flashcard.flipped .flashcard-inner {
            transform: rotateY(180deg);
        }
        /* Prevent text selection on flashcard to make tapping easier */
        .no-select {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* Multi-select styles */
        .multi-select-container {
            position: relative;
        }
        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            display: none;
        }
        .multi-select-dropdown.show {
            display: block;
        }
        .multi-select-option {
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .multi-select-option:hover {
            background-color: #f3f4f6;
        }
        .multi-select-option.selected {
            background-color: #e0e7ff;
        }
        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .selected-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background-color: #e0e7ff;
            border: 1px solid #c7d2fe;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            color: #3730a3;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 right-4 bg-gray-800 text-white px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full opacity-0 z-[70] flex items-center gap-2 max-w-[90vw]">
        <i class="fas fa-check-circle text-green-400 flex-shrink-0"></i>
        <span id="toast-message" class="truncate">Action successful</span>
    </div>

    <!-- Alert Modal -->
    <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-xl max-w-sm w-full p-6 transform transition-all scale-100 animate-[fadeIn_0.2s_ease-out]">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100 mb-4">
                    <i class="fas fa-info text-indigo-600 text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-900 mb-2">Notice</h3>
                <p id="alert-message" class="text-sm text-gray-500 mb-6"></p>
                <button onclick="closeAlertModal()" class="w-full py-2.5 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-xl max-w-sm w-full p-6 transform transition-all scale-100 animate-[fadeIn_0.2s_ease-out]">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-900 mb-2">Confirm Action</h3>
                <p id="confirm-message" class="text-sm text-gray-500 mb-6"></p>
                <div class="flex gap-3">
                    <button onclick="closeConfirmModal()" class="flex-1 py-2.5 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                        Cancel
                    </button>
                    <button id="confirm-yes-btn" class="flex-1 py-2.5 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition-colors">
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Connect Modal -->
    <div id="connect-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6 transform transition-all scale-100 animate-[fadeIn_0.2s_ease-out]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">Connect "<span id="modal-word-display" class="text-indigo-600"></span>"</h3>
                <button onclick="closeConnectModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Connect to...</label>
                    <input type="text" id="modal-conn-word" list="existing-words" placeholder="Search or type word..." class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:border-indigo-500 outline-none transition-colors">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Relationship Type</label>
                    <select id="modal-conn-type" class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:border-indigo-500 outline-none bg-white">
                         <option value="Synonym">Synonym</option>
                         <option value="Antonym">Antonym</option>
                         <option value="Noun Form">Noun Form</option>
                         <option value="Verb Form">Verb Form</option>
                         <option value="Adj Form">Adj Form</option>
                         <option value="Related">Related</option>
                    </select>
                </div>
                
                <div class="flex gap-3 mt-6 pt-2">
                    <button onclick="closeConnectModal()" class="flex-1 py-2.5 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors">Cancel</button>
                    <button onclick="saveNewConnection()" class="flex-1 py-2.5 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors shadow-md">Add Connection</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-xl max-w-2xl w-full p-6 transform transition-all scale-100 animate-[fadeIn_0.2s_ease-out] relative overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">Edit Word</h3>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            
            <form id="edit-form" class="space-y-4">
                <!-- Word Input -->
                <div>
                    <label for="edit-word" class="block text-sm font-medium text-gray-700 mb-1">Word <span class="text-red-500">*</span></label>
                    <input type="text" id="edit-word" required placeholder="e.g. Ephemeral" 
                        class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all">
                </div>

                <!-- Part of Speech - Multi-select -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Parts of Speech <span class="text-red-500">*</span></label>
                    <div class="multi-select-container">
                        <div onclick="toggleMultiSelectDropdown('edit')" class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all bg-white cursor-pointer flex items-center justify-between">
                            <span id="edit-pos-placeholder" class="text-gray-400">Select parts of speech...</span>
                            <i class="fas fa-chevron-down text-gray-400"></i>
                        </div>
                        <div id="edit-pos-dropdown" class="multi-select-dropdown">
                            <!-- Options populated by JS -->
                        </div>
                        <div id="edit-selected-pos" class="selected-tags">
                            <!-- Selected parts of speech will appear here -->
                        </div>
                    </div>
                </div>

                <!-- Meaning -->
                <div>
                    <label for="edit-meaning" class="block text-sm font-medium text-gray-700 mb-1">Meaning <span class="text-red-500">*</span></label>
                    <textarea id="edit-meaning" required rows="3" placeholder="Definition of the word..." 
                        class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all resize-none"></textarea>
                </div>

                <!-- Sentence (Optional) -->
                <div>
                    <label for="edit-sentence" class="block text-sm font-medium text-gray-700 mb-1">Example Sentence <span class="text-gray-400 font-normal">(Optional)</span></label>
                    <textarea id="edit-sentence" rows="2" placeholder="Use it in a sentence..." 
                        class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all resize-none"></textarea>
                </div>

                <!-- Tags (Optional) -->
                <div>
                    <label for="edit-tags" class="block text-sm font-medium text-gray-700 mb-1">Tags <span class="text-gray-400 font-normal">(Optional)</span></label>
                    <div class="relative">
                        <i class="fas fa-tag absolute left-3 top-3 text-gray-400 text-xs"></i>
                        <input type="text" id="edit-tags" placeholder="work, difficult, travel" 
                            class="w-full pl-8 pr-4 py-2 rounded-lg border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all">
                    </div>
                    <p class="text-xs text-gray-500 mt-1 mb-2">Comma separated</p>
                    
                    <!-- Quick Tags Section -->
                    <div id="edit-quick-tags-container" class="flex flex-wrap gap-2">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeEditModal()" class="flex-1 py-2.5 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors">Cancel</button>
                    <button type="submit" 
                        class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2.5 rounded-lg transition-colors shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Detail View Modal -->
    <div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full p-6 transform transition-all scale-100 animate-[fadeIn_0.2s_ease-out] relative overflow-y-auto max-h-[90vh]">
            <button onclick="closeDetailModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded-full transition-colors"><i class="fas fa-times text-lg"></i></button>
            
            <div id="detail-content">
                <!-- Content injected via JS -->
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 min-h-[4rem] py-2 flex flex-wrap items-center justify-between gap-2">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 text-white p-2 rounded-lg shrink-0">
                    <i class="fas fa-book-open text-xl"></i>
                </div>
                <h1 class="text-xl font-bold text-gray-900 tracking-tight truncate">Vocab<span class="text-indigo-600">Master</span></h1>
            </div>
            
            <div class="flex items-center gap-3">
                <div class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full whitespace-nowrap">
                    <span id="word-count" class="font-bold text-indigo-600">0</span> <span class="hidden sm:inline">words collected</span><span class="sm:hidden">words</span>
                </div>
                <div class="h-6 w-px bg-gray-200 mx-1"></div>
                <button onclick="switchTab('settings')" class="text-gray-400 hover:text-indigo-600 transition-colors p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-200" title="Settings">
                    <i class="fas fa-cog text-xl"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8 w-full">
        
        <!-- Tab Navigation -->
        <div class="flex space-x-1 rounded-xl bg-gray-200 p-1 mb-6 sm:mb-8 overflow-x-auto">
            <button onclick="switchTab('add')" id="tab-btn-add" class="flex-1 min-w-[100px] rounded-lg py-2.5 text-sm font-medium leading-5 text-gray-600 hover:bg-white/[0.5] hover:text-indigo-600 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                <i class="fas fa-plus-circle mr-1 sm:mr-2"></i><span class="inline">Add New</span>
            </button>
            <button onclick="switchTab('list')" id="tab-btn-list" class="flex-1 min-w-[100px] rounded-lg py-2.5 text-sm font-bold leading-5 text-indigo-700 bg-white shadow ring-1 ring-black ring-opacity-5 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                <i class="fas fa-list-ul mr-1 sm:mr-2"></i><span class="inline">My List</span>
            </button>
            <button onclick="switchTab('practice')" id="tab-btn-practice" class="flex-1 min-w-[100px] rounded-lg py-2.5 text-sm font-medium leading-5 text-gray-600 hover:bg-white/[0.5] hover:text-indigo-600 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                <i class="fas fa-layer-group mr-1 sm:mr-2"></i><span class="inline">Practice</span>
            </button>
        </div>

        <!-- Tab Content: Add Word -->
        <div id="view-add" class="hidden transition-opacity duration-300 ease-in-out">
            <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100 max-w-2xl mx-auto">
                <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-feather-alt text-indigo-500"></i> New Entry
                </h2>
                
                <form id="vocab-form" class="space-y-4">
                    <!-- Word Input with Auto Button -->
                    <div>
                        <label for="word" class="block text-sm font-medium text-gray-700 mb-1">Word <span class="text-red-500">*</span></label>
                        <div class="relative flex items-center">
                            <input type="text" id="word" required placeholder="e.g. Ephemeral" 
                                class="w-full pl-4 pr-24 py-2 rounded-lg border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all">
                            
                            <!-- Auto Button -->
                            <button type="button" onclick="fetchDefinition()" id="auto-btn" class="absolute right-2 top-1 bottom-1 px-3 bg-indigo-50 hover:bg-indigo-100 text-indigo-600 text-xs font-bold rounded-md transition-colors flex items-center gap-1 border border-indigo-100">
                                <i class="fas fa-magic"></i> Auto
                            </button>
                        </div>
                    </div>

                    <!-- Part of Speech - Multi-select -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Parts of Speech <span class="text-red-500">*</span></label>
                        <div class="multi-select-container">
                            <div onclick="toggleMultiSelectDropdown('add')" class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all bg-white cursor-pointer flex items-center justify-between">
                                <span id="add-pos-placeholder" class="text-gray-400">Select parts of speech...</span>
                                <i class="fas fa-chevron-down text-gray-400"></i>
                            </div>
                            <div id="add-pos-dropdown" class="multi-select-dropdown">
                                <!-- Options populated by JS -->
                            </div>
                            <div id="add-selected-pos" class="selected-tags">
                                <!-- Selected parts of speech will appear here -->
                            </div>
                        </div>
                    </div>

                    <!-- Meaning -->
                    <div>
                        <label for="meaning" class="block text-sm font-medium text-gray-700 mb-1">Meaning <span class="text-red-500">*</span></label>
                        <textarea id="meaning" required rows="3" placeholder="Definition of the word..." 
                            class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all resize-none"></textarea>
                    </div>

                    <!-- Connections (New Section) -->
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Connections <span class="text-gray-400 font-normal">(Synonyms, Forms, etc.)</span></label>
                        
                        <!-- Connection Inputs -->
                        <div class="flex gap-2 mb-2">
                            <div class="relative flex-grow">
                                <input type="text" id="conn-word" list="existing-words" placeholder="Related word..." 
                                    class="w-full px-3 py-2 rounded-lg border border-gray-200 focus:border-indigo-500 outline-none text-sm">
                                <datalist id="existing-words">
                                    <!-- Populated by JS -->
                                </datalist>
                            </div>
                            <select id="conn-type" class="w-1/3 px-3 py-2 rounded-lg border border-gray-200 focus:border-indigo-500 outline-none text-sm bg-white">
                                <option value="Synonym">Synonym</option>
                                <option value="Antonym">Antonym</option>
                                <option value="Noun Form">Noun Form</option>
                                <option value="Verb Form">Verb Form</option>
                                <option value="Adj Form">Adj Form</option>
                                <option value="Related">Related</option>
                            </select>
                            <button type="button" onclick="addConnection()" class="px-3 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-colors">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>

                        <!-- Pending Connections List -->
                        <div id="pending-connections" class="flex flex-wrap gap-2 mt-2 empty:hidden">
                            <!-- JS will inject spans here -->
                        </div>
                    </div>

                    <!-- Sentence (Optional) -->
                    <div>
                        <label for="sentence" class="block text-sm font-medium text-gray-700 mb-1">Example Sentence <span class="text-gray-400 font-normal">(Optional)</span></label>
                        <textarea id="sentence" rows="2" placeholder="Use it in a sentence..." 
                            class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all resize-none"></textarea>
                    </div>

                    <!-- Tags (Optional) -->
                    <div>
                        <label for="tags" class="block text-sm font-medium text-gray-700 mb-1">Tags <span class="text-gray-400 font-normal">(Optional)</span></label>
                        <div class="relative">
                            <i class="fas fa-tag absolute left-3 top-3 text-gray-400 text-xs"></i>
                            <input type="text" id="tags" placeholder="work, difficult, travel" 
                                class="w-full pl-8 pr-4 py-2 rounded-lg border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all">
                        </div>
                        <p class="text-xs text-gray-500 mt-1 mb-2">Comma separated</p>
                        
                        <!-- Quick Tags Section -->
                        <div id="quick-tags-container" class="flex flex-wrap gap-2">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <button type="submit" 
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 rounded-lg transition-colors shadow-md hover:shadow-lg flex items-center justify-center gap-2 active:scale-95 transform">
                        <i class="fas fa-save"></i> Save to Collection
                    </button>
                </form>
            </div>
        </div>

        <!-- Tab Content: List -->
        <div id="view-list" class="space-y-6">
            
            <!-- Search Bar & Filters -->
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 flex flex-col sm:flex-row gap-4 items-center justify-between">
                <!-- Search Input -->
                <div class="relative w-full sm:flex-1 sm:min-w-[200px]">
                    <i class="fas fa-search absolute left-4 top-3.5 text-gray-400"></i>
                    <input type="text" id="search-input" placeholder="Search words..." 
                        class="w-full pl-10 pr-4 py-3 rounded-lg bg-gray-50 border-transparent focus:bg-white focus:border-indigo-300 focus:ring-2 focus:ring-indigo-200 outline-none transition-all text-base">
                </div>

                <!-- Filter Controls -->
                <div class="flex flex-wrap gap-2 w-full sm:w-auto justify-end">
                    <select id="sort-order" onchange="filterWords()" class="flex-1 sm:flex-none px-4 py-3 rounded-lg bg-gray-50 border-transparent focus:bg-white focus:ring-2 focus:ring-indigo-200 outline-none text-sm text-gray-600 cursor-pointer min-w-[120px]">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="az">A to Z</option>
                        <option value="za">Z to A</option>
                    </select>
                    
                    <select id="filter-pos" class="flex-1 sm:flex-none px-4 py-3 rounded-lg bg-gray-50 border-transparent focus:bg-white focus:ring-2 focus:ring-indigo-200 outline-none text-sm text-gray-600 cursor-pointer min-w-[120px]">
                        <option value="all">All Types</option>
                        <!-- Options populated by JS -->
                    </select>
                    <select id="filter-tag" class="flex-1 sm:flex-none px-4 py-3 rounded-lg bg-gray-50 border-transparent focus:bg-white focus:ring-2 focus:ring-indigo-200 outline-none text-sm text-gray-600 cursor-pointer min-w-[120px]">
                        <option value="all">All Tags</option>
                        <!-- Options populated by JS -->
                    </select>
                    <button onclick="exportData()" class="px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg transition-colors" title="Export JSON">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="hidden flex flex-col items-center justify-center py-16 text-center bg-white rounded-2xl border border-dashed border-gray-300">
                <div class="bg-indigo-50 p-4 rounded-full mb-4">
                    <i class="fas fa-feather-alt text-3xl text-indigo-400"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-800">No words added yet</h3>
                <p class="text-gray-500 mt-2 max-w-xs">Start building your vocabulary by adding your first word in the "Add New Word" tab.</p>
            </div>

            <!-- Card Grid -->
            <div id="vocab-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                <!-- Cards will be injected here via JS -->
            </div>
        </div>

        <!-- Tab Content: Practice (Flashcards) -->
        <div id="view-practice" class="hidden w-full max-w-3xl mx-auto">
            
            <!-- Setup Screen -->
            <div id="practice-setup" class="bg-white rounded-2xl shadow-sm p-8 text-center border border-gray-100">
                <div class="bg-indigo-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-layer-group text-indigo-600 text-3xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2 font-serif-display">Smart Practice</h2>
                <p class="text-gray-500 mb-8">Prioritizes words you haven't mastered yet.</p>
                
                <div class="max-w-sm mx-auto space-y-4">
                    <!-- NEW: Limit Number of Words -->
                    <div>
                         <label class="block text-sm font-medium text-gray-700 mb-2 text-left">Number of Words</label>
                         <input type="number" id="practice-limit" min="1" value="10" class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-indigo-500 bg-white outline-none">
                         <p class="text-xs text-gray-400 text-left mt-1">Leave empty for all</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2 text-left">Filter by Tag (Optional)</label>
                        <select id="practice-filter-tag" class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-indigo-500 bg-white">
                            <option value="all">All Words</option>
                            <!-- Populated by JS -->
                        </select>
                    </div>
                    
                    <div class="flex items-center justify-between bg-gray-50 p-4 rounded-lg border border-gray-100">
                        <span class="text-sm font-medium text-gray-700">Shuffle Randomly</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="practice-shuffle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                        </label>
                    </div>
                    <p class="text-xs text-gray-400 text-left ml-1">Default: Sorts by mastery (Hardest words first)</p>

                    <button onclick="startPractice()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5">
                        Start Session
                    </button>
                </div>
            </div>

            <!-- Game Screen -->
            <div id="practice-game" class="hidden flex-col h-[600px]">
                
                <!-- Progress Bar -->
                <div class="flex items-center justify-between mb-6 px-2">
                    <button onclick="exitPractice()" class="text-sm text-gray-500 hover:text-gray-800 flex items-center gap-1">
                        <i class="fas fa-arrow-left"></i> Exit
                    </button>
                    <div class="text-sm font-medium text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full">
                        Card <span id="current-card-num">1</span> of <span id="total-card-num">10</span>
                    </div>
                </div>

                <!-- Flashcard Container -->
                <div class="flex-grow perspective-1000 w-full relative group">
                    <!-- Added 'no-select' and click handler -->
                    <div id="flashcard" class="relative w-full h-full transform-style-3d transition-transform duration-500 cursor-pointer shadow-xl rounded-2xl no-select" onclick="flipCard()">
                        
                        <!-- Front Face -->
                        <div class="absolute w-full h-full backface-hidden bg-white rounded-2xl border-2 border-indigo-50 flex flex-col items-center justify-center p-8 text-center">
                            <span class="text-sm uppercase tracking-widest text-gray-400 mb-4 font-semibold">Word</span>
                            <h2 id="fc-front-word" class="text-4xl sm:text-5xl font-bold text-gray-900 font-serif-display mb-4">Ephemeral</h2>
                            <div id="fc-front-pos" class="flex flex-wrap gap-1 justify-center">
                                <!-- Parts of speech will be injected here -->
                            </div>
                            
                            <div class="absolute bottom-8 text-gray-400 text-sm animate-pulse">
                                <i class="fas fa-sync-alt mr-2"></i> Tap to flip
                            </div>
                        </div>

                        <!-- Back Face -->
                        <div class="absolute w-full h-full backface-hidden rotate-y-180 bg-indigo-600 text-white rounded-2xl flex flex-col items-center justify-center p-8 text-center overflow-y-auto">
                             <div class="w-full max-w-md space-y-6">
                                <div>
                                    <span class="text-xs uppercase tracking-widest text-indigo-200 font-semibold">Meaning</span>
                                    <p id="fc-back-meaning" class="text-xl sm:text-2xl font-medium mt-2 leading-relaxed">Lasting for a very short time.</p>
                                </div>

                                <div id="fc-back-sentence-container" class="hidden">
                                    <div class="h-px bg-indigo-500 w-1/3 mx-auto my-4"></div>
                                    <p id="fc-back-sentence" class="text-indigo-100 italic text-lg">"Fashions are ephemeral, changing with every season."</p>
                                </div>

                                <button onclick="event.stopPropagation(); speakWord(currentPracticeCard.word)" class="mt-4 p-3 bg-white/20 hover:bg-white/30 rounded-full transition-colors text-white">
                                    <i class="fas fa-volume-up text-lg"></i>
                                </button>
                             </div>
                        </div>
                    </div>
                </div>

                <!-- Updated Controls -->
                <div class="mt-8 grid grid-cols-3 gap-4">
                    <button onclick="markResult(false)" class="py-3 bg-red-100 text-red-700 border border-red-200 rounded-xl font-bold hover:bg-red-200 transition-colors shadow-sm flex flex-col items-center justify-center leading-tight">
                        <span>Missed it</span>
                        <span class="text-[10px] font-normal">Reset score</span>
                    </button>
                    
                    <button onclick="flipCard()" class="py-3 bg-gray-100 text-gray-700 border border-gray-200 rounded-xl font-medium hover:bg-gray-200 transition-colors shadow-sm">
                        Flip Card
                    </button>

                    <button onclick="markResult(true)" class="py-3 bg-green-100 text-green-700 border border-green-200 rounded-xl font-bold hover:bg-green-200 transition-colors shadow-sm flex flex-col items-center justify-center leading-tight">
                        <span>Got it!</span>
                        <span class="text-[10px] font-normal">+1 Mastery</span>
                    </button>
                </div>
            </div>
            
            <!-- Summary Screen -->
            <div id="practice-summary" class="hidden bg-white rounded-2xl shadow-sm p-8 text-center border border-gray-100 flex-col items-center justify-center py-12">
                <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-4xl mb-6 mx-auto">
                    <i class="fas fa-check"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Session Complete!</h2>
                <p class="text-gray-500 mb-8">You reviewed <span id="summary-count" class="font-bold text-indigo-600">0</span> words.</p>
                
                <div class="flex gap-4 justify-center w-full max-w-xs mx-auto">
                     <button onclick="exitPractice()" class="flex-1 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-xl transition-colors">
                        Back to List
                    </button>
                    <button onclick="startPractice()" class="flex-1 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-md transition-colors">
                        Practice Again
                    </button>
                </div>
            </div>
            
            <!-- Empty Practice State -->
            <div id="practice-empty" class="hidden bg-white rounded-2xl shadow-sm p-8 text-center border border-dashed border-gray-300">
                <div class="bg-gray-50 p-4 rounded-full inline-block mb-4">
                    <i class="fas fa-inbox text-3xl text-gray-400"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">No words found</h3>
                <p class="text-gray-500 mb-6">Add words to your list or change your filters to start practicing.</p>
                <button onclick="exitPractice()" class="text-indigo-600 hover:text-indigo-800 font-medium">Go Back</button>
            </div>
        </div>

        <!-- Tab Content: Settings -->
        <div id="view-settings" class="hidden space-y-6">
            
            <!-- General Settings / Language Selection -->
            <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-globe text-indigo-500"></i> General Settings
                </h3>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Auto-Definition Language</label>
                    <p class="text-xs text-gray-500 mb-2">Choose the language for the "Auto" button result.</p>
                    <select id="settings-lang" onchange="saveLanguageSetting()" class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:border-indigo-500 bg-white outline-none">
                        <option value="en_US">English (Definition)</option>
                        <option value="zh-TW">Traditional Chinese / 繁體中文</option>
                        <option value="es-ES">Spanish / Español</option>
                        <option value="fr-FR">French / Français</option>
                        <option value="de-DE">German / Deutsch</option>
                        <option value="it-IT">Italian / Italiano</option>
                        <option value="pt-PT">Portuguese / Português</option>
                        <option value="ja-JP">Japanese / 日本語</option>
                        <option value="zh-CN">Simplified Chinese / 简体中文</option>
                        <option value="ru-RU">Russian / Русский</option>
                    </select>
                </div>
            </div>

            <!-- Manage Tags Section -->
            <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-tags text-indigo-500"></i> Manage Saved Tags
                </h3>
                <p class="text-sm text-gray-500 mb-4">Create preset tags for quick access when adding new words.</p>
                
                <div class="flex gap-2 mb-6">
                    <input type="text" id="new-tag-input" placeholder="New tag (e.g. IELTS)" 
                        class="flex-1 px-4 py-2 rounded-lg border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all">
                    <button onclick="addNewTag()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors">
                        Add
                    </button>
                </div>

                <div id="settings-tags-list" class="flex flex-wrap gap-2">
                    <!-- JS injected chips -->
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="bg-white rounded-2xl shadow-sm p-6 border border-red-100 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1 h-full bg-red-500"></div>
                <h3 class="text-lg font-bold text-red-700 mb-2 flex items-center gap-2">
                    <i class="fas fa-exclamation-triangle"></i> Danger Zone
                </h3>
                <p class="text-gray-600 text-sm mb-6">These actions are irreversible. Proceed with caution.</p>
                
                <button onclick="clearAll()" class="w-full sm:w-auto px-6 py-3 bg-red-50 text-red-700 border border-red-200 rounded-lg font-medium hover:bg-red-100 hover:border-red-300 transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-trash-alt"></i> Delete All Vocabulary
                </button>
            </div>
        </div>

    </main>

    <footer class="bg-white border-t border-gray-200 mt-auto">
        <div class="max-w-7xl mx-auto px-4 py-6 text-center">
            <p class="text-sm text-gray-500">Saved locally in your browser.</p>
        </div>
    </footer>

    <script>
        // State Management
        const defaultTypes = ['Noun', 'Verb', 'Adjective', 'Adverb', 'Preposition', 'Conjunction', 'Idiom', 'Phrase'];
        let vocabList = JSON.parse(localStorage.getItem('vocabList')) || [];
        let savedTags = JSON.parse(localStorage.getItem('savedTags')) || ['Important', 'To Review', 'Work'];
        
        let currentConnections = []; 
        let currentEditingId = null; 
        let confirmCallback = null; 
        
        // Practice Mode State
        let practiceDeck = [];
        let practiceIndex = 0;
        let currentPracticeCard = null;
        let practiceResults = { correct: 0, total: 0 };

        // Multi-select state
        let selectedPositions = {
            add: [],
            edit: []
        };

        // DOM Elements
        const form = document.getElementById('vocab-form');
        const listContainer = document.getElementById('vocab-list');
        const searchInput = document.getElementById('search-input');
        const filterPos = document.getElementById('filter-pos');
        const filterTag = document.getElementById('filter-tag');
        const sortOrder = document.getElementById('sort-order');
        const emptyState = document.getElementById('empty-state');
        const wordCountSpan = document.getElementById('word-count');
        const toast = document.getElementById('toast');
        const toastMsg = document.getElementById('toast-message');
        const pendingConnContainer = document.getElementById('pending-connections');
        const datalist = document.getElementById('existing-words');
        const connectModal = document.getElementById('connect-modal');
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const detailModal = document.getElementById('detail-modal');
        const alertModal = document.getElementById('alert-modal');
        const confirmModal = document.getElementById('confirm-modal');
        const settingsTagsList = document.getElementById('settings-tags-list');
        const newTagInput = document.getElementById('new-tag-input');
        const quickTagsContainer = document.getElementById('quick-tags-container');
        const editQuickTagsContainer = document.getElementById('edit-quick-tags-container');
        const tagsInput = document.getElementById('tags');
        const editTagsInput = document.getElementById('edit-tags');
        
        // Practice Elements
        const practiceSetup = document.getElementById('practice-setup');
        const practiceGame = document.getElementById('practice-game');
        const practiceEmpty = document.getElementById('practice-empty');
        const practiceSummary = document.getElementById('practice-summary');
        const practiceFilterTag = document.getElementById('practice-filter-tag');
        const practiceLimit = document.getElementById('practice-limit'); // NEW
        const flashcard = document.getElementById('flashcard');
        const fcFrontWord = document.getElementById('fc-front-word');
        const fcFrontPos = document.getElementById('fc-front-pos');
        const fcBackMeaning = document.getElementById('fc-back-meaning');
        const fcBackSentence = document.getElementById('fc-back-sentence');
        const fcBackSentenceContainer = document.getElementById('fc-back-sentence-container');
        const currentCardNum = document.getElementById('current-card-num');
        const totalCardNum = document.getElementById('total-card-num');
        const summaryCount = document.getElementById('summary-count');


        // --- Global Modal Helpers ---
        window.showAlert = (message) => {
            document.getElementById('alert-message').textContent = message;
            alertModal.classList.remove('hidden');
        };
        window.closeAlertModal = () => {
            alertModal.classList.add('hidden');
        };

        window.showConfirm = (message, callback) => {
            document.getElementById('confirm-message').textContent = message;
            confirmCallback = callback;
            confirmModal.classList.remove('hidden');
        };
        window.closeConfirmModal = () => {
            confirmModal.classList.add('hidden');
            confirmCallback = null;
        };

        document.getElementById('confirm-yes-btn').addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            closeConfirmModal();
        });
        
        // Close Alert/Confirm on outside click
        alertModal.addEventListener('click', (e) => { if(e.target === alertModal) closeAlertModal(); });
        confirmModal.addEventListener('click', (e) => { if(e.target === confirmModal) closeConfirmModal(); });


        // Tab Switching Logic
        window.switchTab = (tabName) => {
            const views = ['add', 'list', 'settings', 'practice'];
            
            views.forEach(view => {
                const el = document.getElementById(`view-${view}`);
                const btn = document.getElementById(`tab-btn-${view}`);
                
                if (view === tabName) {
                    el.classList.remove('hidden');
                    if (btn) {
                        btn.classList.add('bg-white', 'text-indigo-700', 'shadow', 'font-bold');
                        btn.classList.remove('text-gray-600', 'font-medium', 'hover:bg-white/[0.5]');
                    }
                } else {
                    el.classList.add('hidden');
                    if (btn) {
                        btn.classList.remove('bg-white', 'text-indigo-700', 'shadow', 'font-bold');
                        btn.classList.add('text-gray-600', 'font-medium', 'hover:bg-white/[0.5]');
                    }
                }
            });
        };

        // Colors
        const posColors = {
            'Noun': 'bg-blue-100 text-blue-700 border-blue-200',
            'Verb': 'bg-green-100 text-green-700 border-green-200',
            'Adjective': 'bg-purple-100 text-purple-700 border-purple-200',
            'Adverb': 'bg-yellow-100 text-yellow-700 border-yellow-200',
            'Preposition': 'bg-pink-100 text-pink-700 border-pink-200',
            'Conjunction': 'bg-indigo-100 text-indigo-700 border-indigo-200',
            'Idiom': 'bg-red-100 text-red-700 border-red-200',
            'Phrase': 'bg-teal-100 text-teal-700 border-teal-200',
            'default': 'bg-gray-100 text-gray-700 border-gray-200'
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            renderList(vocabList);
            renderMultiSelectOptions();
            renderSettingsTags();
            renderQuickTags();
            updateTagFilterOptions();
            updateDatalist();
            updatePracticeFilter();
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.multi-select-container')) {
                    closeAllDropdowns();
                }
            });
        });

        // --- Multi-select Functions ---
        function renderMultiSelectOptions() {
            const addDropdown = document.getElementById('add-pos-dropdown');
            const editDropdown = document.getElementById('edit-pos-dropdown');
            
            const optionsHtml = defaultTypes.map(type => `
                <div class="multi-select-option" onclick="togglePosSelection('${type}', 'add')">
                    <input type="checkbox" id="add-pos-${type}" class="hidden">
                    <i class="fas fa-check text-indigo-600 opacity-0 w-4"></i>
                    <span>${type}</span>
                </div>
            `).join('');
            
            addDropdown.innerHTML = optionsHtml;
            editDropdown.innerHTML = optionsHtml.replace(/add/g, 'edit');
        }

        window.toggleMultiSelectDropdown = (type) => {
            const dropdown = document.getElementById(`${type}-pos-dropdown`);
            const allDropdowns = document.querySelectorAll('.multi-select-dropdown');
            
            allDropdowns.forEach(d => {
                if (d !== dropdown) d.classList.remove('show');
            });
            
            dropdown.classList.toggle('show');
        };

        function closeAllDropdowns() {
            document.querySelectorAll('.multi-select-dropdown').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
        }

        window.togglePosSelection = (pos, type) => {
            const index = selectedPositions[type].indexOf(pos);
            const option = document.querySelector(`#${type}-pos-dropdown .multi-select-option:nth-child(${defaultTypes.indexOf(pos) + 1})`);
            const checkbox = document.getElementById(`${type}-pos-${pos}`);
            const icon = option.querySelector('i');
            
            if (index === -1) {
                // Add to selection
                selectedPositions[type].push(pos);
                icon.classList.remove('opacity-0');
                option.classList.add('selected');
            } else {
                // Remove from selection
                selectedPositions[type].splice(index, 1);
                icon.classList.add('opacity-0');
                option.classList.remove('selected');
            }
            
            updateSelectedPosDisplay(type);
        };

        function updateSelectedPosDisplay(type) {
            const container = document.getElementById(`${type}-selected-pos`);
            const placeholder = document.getElementById(`${type}-pos-placeholder`);
            
            container.innerHTML = '';
            
            if (selectedPositions[type].length === 0) {
                placeholder.textContent = 'Select parts of speech...';
                placeholder.classList.add('text-gray-400');
            } else {
                placeholder.textContent = '';
                
                selectedPositions[type].forEach(pos => {
                    const tag = document.createElement('span');
                    tag.className = 'selected-tag';
                    tag.innerHTML = `
                        ${pos}
                        <button type="button" onclick="removePosSelection('${pos}', '${type}')" class="hover:text-indigo-900">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    `;
                    container.appendChild(tag);
                });
            }
        }

        window.removePosSelection = (pos, type) => {
            const index = selectedPositions[type].indexOf(pos);
            if (index !== -1) {
                selectedPositions[type].splice(index, 1);
                updateSelectedPosDisplay(type);
                
                // Also update the dropdown visual state
                const option = document.querySelector(`#${type}-pos-dropdown .multi-select-option:nth-child(${defaultTypes.indexOf(pos) + 1})`);
                const icon = option.querySelector('i');
                icon.classList.add('opacity-0');
                option.classList.remove('selected');
            }
        };

        function clearPosSelection(type) {
            selectedPositions[type] = [];
            updateSelectedPosDisplay(type);
            
            // Reset all dropdown options
            defaultTypes.forEach(pos => {
                const option = document.querySelector(`#${type}-pos-dropdown .multi-select-option:nth-child(${defaultTypes.indexOf(pos) + 1})`);
                const icon = option.querySelector('i');
                if (option && icon) {
                    icon.classList.add('opacity-0');
                    option.classList.remove('selected');
                }
            });
        }

        // --- Practice Mode Logic ---
        function updatePracticeFilter() {
             const allTags = new Set();
             vocabList.forEach(word => {
                if (word.tags) word.tags.forEach(tag => allTags.add(tag));
             });
             const sortedTags = Array.from(allTags).sort();
             practiceFilterTag.innerHTML = '<option value="all">All Words</option>' + 
                sortedTags.map(tag => `<option value="${tag}">#${tag}</option>`).join('');
        }

        window.startPractice = () => {
            const tagFilter = practiceFilterTag.value;
            const shouldShuffle = document.getElementById('practice-shuffle').checked;
            // NEW: Card Limit
            const limitVal = parseInt(practiceLimit.value);

            // Filter Deck
            let tempDeck = vocabList.filter(item => {
                if (tagFilter === 'all') return true;
                return item.tags && item.tags.includes(tagFilter);
            });

            if (tempDeck.length === 0) {
                practiceSetup.classList.add('hidden');
                practiceEmpty.classList.remove('hidden');
                return;
            }

            // Sorting Logic: Priority to words with lower mastery (if not shuffling)
            if (shouldShuffle) {
                tempDeck.sort(() => Math.random() - 0.5);
            } else {
                // Smart Sort: Mastery 0 first, then 1, etc.
                tempDeck.sort((a, b) => (a.mastery || 0) - (b.mastery || 0));
            }
            
            // Apply Limit logic
            if (!isNaN(limitVal) && limitVal > 0) {
                tempDeck = tempDeck.slice(0, limitVal);
            }

            practiceDeck = tempDeck;
            practiceIndex = 0;
            practiceResults = { correct: 0, total: practiceDeck.length };

            practiceSetup.classList.add('hidden');
            practiceEmpty.classList.add('hidden');
            practiceSummary.classList.add('hidden');
            practiceGame.classList.remove('hidden');
            practiceGame.classList.add('flex');
            
            renderCard();
        };

        window.exitPractice = () => {
            practiceGame.classList.add('hidden');
            practiceGame.classList.remove('flex');
            practiceEmpty.classList.add('hidden');
            practiceSummary.classList.add('hidden');
            practiceSetup.classList.remove('hidden');
            // Refresh list to show updated mastery scores
            renderList(vocabList);
        };

        window.renderCard = () => {
            flashcard.classList.remove('flipped');
            
            currentPracticeCard = practiceDeck[practiceIndex];
            
            fcFrontWord.textContent = currentPracticeCard.word;
            
            // Multiple parts of speech
            fcFrontPos.innerHTML = currentPracticeCard.pos.map(pos => {
                const posClass = posColors[pos] || posColors['default'];
                return `<span class="px-2 py-1 rounded-full text-xs font-medium border ${posClass}">${pos}</span>`;
            }).join('');
            
            setTimeout(() => {
                fcBackMeaning.textContent = currentPracticeCard.meaning;
                
                if (currentPracticeCard.sentence) {
                    fcBackSentence.textContent = `"${currentPracticeCard.sentence}"`;
                    fcBackSentenceContainer.classList.remove('hidden');
                } else {
                    fcBackSentenceContainer.classList.add('hidden');
                }
            }, 300);

            currentCardNum.textContent = practiceIndex + 1;
            totalCardNum.textContent = practiceDeck.length;
        };

        window.flipCard = () => {
            flashcard.classList.toggle('flipped');
        };

        // Mark result: "Got it" or "Missed it"
        window.markResult = (success) => {
            // Update Mastery Score
            const wordIndex = vocabList.findIndex(w => w.id === currentPracticeCard.id);
            if (wordIndex !== -1) {
                let currentMastery = vocabList[wordIndex].mastery || 0;
                if (success) {
                    vocabList[wordIndex].mastery = Math.min(currentMastery + 1, 5);
                    practiceResults.correct++;
                } else {
                    vocabList[wordIndex].mastery = Math.max(0, currentMastery - 1); // Reset or decrease
                }
                saveData(); // Save the progress immediately
            }

            // Next Card
            if (practiceIndex < practiceDeck.length - 1) {
                practiceIndex++;
                renderCard();
            } else {
                finishPractice();
            }
        };

        function finishPractice() {
            practiceGame.classList.add('hidden');
            practiceGame.classList.remove('flex');
            summaryCount.textContent = practiceDeck.length;
            practiceSummary.classList.remove('hidden');
            practiceSummary.classList.add('flex');
        }

        // Keyboard support for practice
        document.addEventListener('keydown', (e) => {
            if (!practiceGame.classList.contains('hidden')) {
                if (e.code === 'Space' || e.code === 'Enter') {
                    e.preventDefault(); // Prevent scrolling
                    flipCard();
                }
                // Can add shortcuts for correct/incorrect if desired, e.g. Left/Right arrows
            }
        });


        // --- Edit Modal ---
        window.openEditModal = (id) => {
            const item = vocabList.find(w => w.id === id);
            if (!item) return;
            
            currentEditingId = id;
            
            // Populate form fields
            document.getElementById('edit-word').value = item.word;
            document.getElementById('edit-meaning').value = item.meaning;
            document.getElementById('edit-sentence').value = item.sentence || '';
            document.getElementById('edit-tags').value = item.tags.join(', ');
            
            // Set parts of speech
            selectedPositions.edit = Array.isArray(item.pos) ? [...item.pos] : [item.pos];
            updateSelectedPosDisplay('edit');
            
            // Update dropdown visual state
            defaultTypes.forEach(pos => {
                const option = document.querySelector(`#edit-pos-dropdown .multi-select-option:nth-child(${defaultTypes.indexOf(pos) + 1})`);
                const icon = option.querySelector('i');
                if (selectedPositions.edit.includes(pos)) {
                    icon.classList.remove('opacity-0');
                    option.classList.add('selected');
                } else {
                    icon.classList.add('opacity-0');
                    option.classList.remove('selected');
                }
            });
            
            // Show modal
            editModal.classList.remove('hidden');
            document.getElementById('edit-word').focus();
        };

        window.closeEditModal = () => {
            editModal.classList.add('hidden');
            currentEditingId = null;
            clearPosSelection('edit');
        };

        // Handle edit form submission
        editForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            if (!currentEditingId) return;
            
            const index = vocabList.findIndex(w => w.id === currentEditingId);
            if (index === -1) return;
            
            // Validate at least one part of speech is selected
            if (selectedPositions.edit.length === 0) {
                showAlert('Please select at least one part of speech.');
                return;
            }
            
            // Update the word
            vocabList[index] = {
                ...vocabList[index],
                word: document.getElementById('edit-word').value.trim(),
                pos: [...selectedPositions.edit], // Store as array
                meaning: document.getElementById('edit-meaning').value.trim(),
                sentence: document.getElementById('edit-sentence').value.trim(),
                tags: document.getElementById('edit-tags').value.split(',').map(t => t.trim()).filter(t => t)
            };
            
            // Update connections that reference this word
            vocabList.forEach((word, i) => {
                if (word.connections) {
                    word.connections.forEach(conn => {
                        if (conn.word.toLowerCase() === vocabList[index].word.toLowerCase()) {
                            // Update the connection to use the new word
                            conn.word = vocabList[index].word;
                        }
                    });
                }
            });
            
            saveData();
            renderList(vocabList);
            updateDatalist();
            closeEditModal();
            showToast(`Updated "${vocabList[index].word}" successfully!`);
        });

        // --- Detail View Modal ---
        window.openDetailModal = (id) => {
            const item = vocabList.find(w => w.id === id);
            if (!item) return;

            // Handle both array and string pos for backward compatibility
            const posArray = Array.isArray(item.pos) ? item.pos : [item.pos];
            const posHtml = posArray.map(pos => {
                const posClass = posColors[pos] || posColors['default'];
                return `<span class="px-3 py-1 rounded-full text-sm font-semibold border ${posClass}">${pos}</span>`;
            }).join('');
            
            const tagsHtml = item.tags.map(tag => `<span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-full">#${tag}</span>`).join('');
            
            const connectionsHtml = (item.connections && item.connections.length > 0)
                ? `<div class="mt-6 pt-4 border-t border-gray-100">
                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Connections</h4>
                    <div class="grid grid-cols-1 gap-3">
                        ${item.connections.map(c => {
                            const linkedWord = vocabList.find(w => w.word.toLowerCase() === c.word.toLowerCase());
                            const linkedPos = linkedWord ? (Array.isArray(linkedWord.pos) ? linkedWord.pos.join(', ') : linkedWord.pos) : 'N/A';
                            const linkedMeaning = linkedWord ? linkedWord.meaning : 'Definition not available';
                            const linkedPosStyle = 'bg-gray-200 text-gray-600 border-gray-300'; // Simplified for multiple POS

                            return `
                            <div onclick="searchFor('${c.word}'); closeDetailModal();" class="flex flex-col sm:flex-row gap-2 sm:gap-4 p-3 rounded-lg bg-gray-50 border border-gray-100 hover:bg-indigo-50 hover:border-indigo-100 transition-all cursor-pointer group">
                                <div class="flex-shrink-0 sm:w-1/3">
                                    <div class="flex items-center gap-2 flex-wrap mb-1">
                                        <span class="font-bold text-gray-800 group-hover:text-indigo-700 transition-colors">${c.word}</span>
                                        <span class="text-[10px] px-1.5 py-0.5 rounded border ${linkedPosStyle}">${linkedPos}</span>
                                    </div>
                                    <div class="text-xs text-indigo-500 font-medium bg-indigo-50 inline-block px-1.5 rounded border border-indigo-100">${c.type}</div>
                                </div>
                                <div class="text-sm text-gray-600 leading-snug border-t sm:border-t-0 sm:border-l border-gray-100 sm:pl-4 pt-2 sm:pt-0 flex items-center">
                                    ${linkedMeaning}
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                   </div>`
                : '';

            const sentenceHtml = item.sentence 
                ? `<div class="mt-6 bg-gray-50 p-5 rounded-xl border-l-4 border-indigo-400 relative">
                     <i class="fas fa-quote-left absolute top-3 left-3 text-indigo-200 text-xl"></i>
                     <p class="text-gray-800 italic text-lg leading-relaxed pl-4">"${item.sentence}"</p>
                   </div>` 
                : '';

            const html = `
                <div class="pr-8">
                    <div class="flex flex-wrap items-center gap-3 mb-2">
                        <h2 class="text-3xl font-bold text-gray-900 font-serif-display">${item.word}</h2>
                        <button onclick="speakWord('${item.word.replace(/'/g, "\\'")}')" class="text-gray-400 hover:text-indigo-600 transition-colors p-2 rounded-full hover:bg-indigo-50" title="Listen">
                            <i class="fas fa-volume-up text-xl"></i>
                        </button>
                        <div class="flex flex-wrap gap-2">
                            ${posHtml}
                        </div>
                    </div>
                    <div class="text-gray-400 text-sm mb-4">Added on ${item.dateAdded || 'Unknown date'}</div>
                </div>

                <div class="prose text-gray-700 leading-relaxed text-lg">
                    ${item.meaning}
                </div>

                ${sentenceHtml}

                ${connectionsHtml}

                ${item.tags.length > 0 ? `<div class="mt-6 pt-4 border-t border-gray-100 flex flex-wrap gap-2">${tagsHtml}</div>` : ''}
                
                <div class="mt-8 flex justify-end gap-3 border-t border-gray-100 pt-4">
                    <button onclick="openEditModal(${item.id}); closeDetailModal();" class="px-4 py-2 text-indigo-600 hover:bg-indigo-50 rounded-lg font-medium transition-colors flex items-center gap-2">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button onclick="openConnectModal(${item.id}); closeDetailModal();" class="px-4 py-2 text-indigo-600 hover:bg-indigo-50 rounded-lg font-medium transition-colors flex items-center gap-2">
                        <i class="fas fa-link"></i> Connect
                    </button>
                    <button onclick="deleteWord(${item.id}); closeDetailModal();" class="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg font-medium transition-colors flex items-center gap-2">
                        <i class="fas fa-trash-alt"></i> Delete
                    </button>
                </div>
            `;

            document.getElementById('detail-content').innerHTML = html;
            detailModal.classList.remove('hidden');
        };

        window.closeDetailModal = () => {
             detailModal.classList.add('hidden');
        };
        detailModal.addEventListener('click', (e) => {
            if (e.target === detailModal) closeDetailModal();
        });

        // Close Edit Modal on outside click
        editModal.addEventListener('click', (e) => {
            if (e.target === editModal) closeEditModal();
        });

        // --- Filter Options ---
        function updateTagFilterOptions() {
            const currentSelection = filterTag.value;
            const allTags = new Set();
            savedTags.forEach(tag => allTags.add(tag));
            vocabList.forEach(word => {
                if (word.tags) word.tags.forEach(tag => allTags.add(tag));
            });
            const sortedTags = Array.from(allTags).sort();
            
            // Update filter options to show all parts of speech
            const allPositions = new Set();
            vocabList.forEach(word => {
                const posArray = Array.isArray(word.pos) ? word.pos : [word.pos];
                posArray.forEach(pos => allPositions.add(pos));
            });
            const sortedPositions = Array.from(allPositions).sort();
            
            filterPos.innerHTML = '<option value="all">All Types</option>' + 
                sortedPositions.map(pos => `<option value="${pos}">${pos}</option>`).join('');
            
            filterTag.innerHTML = '<option value="all">All Tags</option>' + 
                sortedTags.map(tag => `<option value="${tag}">#${tag}</option>`).join('');
                
            if (allTags.has(currentSelection)) filterTag.value = currentSelection;
        }

        // --- Tag Management ---
        function renderSettingsTags() {
            settingsTagsList.innerHTML = savedTags.map(tag => {
                const escapedTag = tag.replace(/'/g, "\\'");
                return `
                <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-gray-100 border border-gray-200 text-gray-700 text-sm group hover:bg-gray-200 transition-colors">
                    #${tag}
                    <button onclick="deleteSavedTag('${escapedTag}')" class="text-gray-400 hover:text-red-600 hover:bg-red-100 w-5 h-5 flex items-center justify-center rounded-full transition-colors" title="Delete Tag">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
            `}).join('');
        }

        function renderQuickTags() {
            if(savedTags.length === 0) {
                quickTagsContainer.innerHTML = '';
                editQuickTagsContainer.innerHTML = '';
                return;
            }
            quickTagsContainer.innerHTML = '<span class="text-xs text-gray-400 self-center mr-1">Quick Add:</span>' + 
                savedTags.map(tag => {
                    const escapedTag = tag.replace(/'/g, "\\'");
                    return `
                    <button type="button" onclick="addTagToInput('${escapedTag}')" class="px-2 py-1 rounded-md bg-indigo-50 text-indigo-600 text-xs font-medium border border-indigo-100 hover:bg-indigo-100 transition-colors">
                        + ${tag}
                    </button>
                `}).join('');
                
            editQuickTagsContainer.innerHTML = '<span class="text-xs text-gray-400 self-center mr-1">Quick Add:</span>' + 
                savedTags.map(tag => {
                    const escapedTag = tag.replace(/'/g, "\\'");
                    return `
                    <button type="button" onclick="addTagToEditInput('${escapedTag}')" class="px-2 py-1 rounded-md bg-indigo-50 text-indigo-600 text-xs font-medium border border-indigo-100 hover:bg-indigo-100 transition-colors">
                        + ${tag}
                    </button>
                `}).join('');
        }

        window.addNewTag = () => {
            const val = newTagInput.value.trim();
            if (val && !savedTags.includes(val)) {
                savedTags.push(val);
                saveTags();
                renderSettingsTags();
                renderQuickTags();
                updateTagFilterOptions();
                updatePracticeFilter();
                newTagInput.value = '';
                showToast(`Added tag "${val}"`);
            } else if (savedTags.includes(val)) {
                showAlert('Tag already exists!');
            }
        };

        window.deleteSavedTag = (tag) => {
            const usageCount = vocabList.filter(word => word.tags.includes(tag)).length;
            
            showConfirm(`Remove tag preset "${tag}"?`, () => {
                // 1. Remove from Saved Tags
                savedTags = savedTags.filter(t => t !== tag);
                saveTags();
                
                // 2. Remove from words confirmation
                if (usageCount > 0) {
                    setTimeout(() => {
                        showConfirm(`This tag is used in ${usageCount} words. Remove from words too?`, () => {
                             vocabList = vocabList.map(word => {
                                if (word.tags.includes(tag)) {
                                    word.tags = word.tags.filter(t => t !== tag);
                                }
                                return word;
                            });
                            saveData();
                            renderList(vocabList);
                            showToast(`Removed tag "${tag}" everywhere`);
                        });
                    }, 300); // Small delay for nice UX
                } else {
                    showToast(`Removed tag preset "${tag}"`);
                }

                renderSettingsTags();
                renderQuickTags();
                updateTagFilterOptions();
                updatePracticeFilter();
            });
        };

        window.addTagToInput = (tag) => {
            const current = tagsInput.value.trim();
            if(current.includes(tag)) return;
            if(current.length > 0 && !current.endsWith(',')) {
                tagsInput.value = current + ', ' + tag;
            } else {
                tagsInput.value = current + tag;
            }
            tagsInput.focus();
        };

        window.addTagToEditInput = (tag) => {
            const current = editTagsInput.value.trim();
            if(current.includes(tag)) return;
            if(current.length > 0 && !current.endsWith(',')) {
                editTagsInput.value = current + ', ' + tag;
            } else {
                editTagsInput.value = current + tag;
            }
            editTagsInput.focus();
        };

        function saveTags() {
            localStorage.setItem('savedTags', JSON.stringify(savedTags));
        }

        function updateDatalist() {
            datalist.innerHTML = vocabList.map(item => `<option value="${item.word}">`).join('');
        }

        // --- Connection Logic ---
        window.addConnection = () => {
            const wordInput = document.getElementById('conn-word');
            const typeInput = document.getElementById('conn-type');
            const word = wordInput.value.trim();
            const type = typeInput.value;

            if (!word) return;

            const exists = vocabList.some(w => w.word.toLowerCase() === word.toLowerCase());
            if (!exists) {
                showAlert(`"${word}" is not in your vocabulary list yet. Please add it first.`);
                return;
            }

            currentConnections.push({ word, type });
            renderPendingConnections();
            
            wordInput.value = '';
            wordInput.focus();
        };

        window.removeConnection = (index) => {
            currentConnections.splice(index, 1);
            renderPendingConnections();
        };

        function renderPendingConnections() {
            pendingConnContainer.innerHTML = currentConnections.map((conn, index) => `
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium bg-indigo-50 text-indigo-700 border border-indigo-100">
                    ${conn.word} <span class="opacity-50">(${conn.type})</span>
                    <button type="button" onclick="removeConnection(${index})" class="ml-1 hover:text-indigo-900"><i class="fas fa-times"></i></button>
                </span>
            `).join('');
        }

        // --- Modal Connection ---
        window.openConnectModal = (id) => {
            currentEditingId = id;
            const item = vocabList.find(w => w.id === id);
            if (!item) return;

            document.getElementById('modal-word-display').textContent = item.word;
            document.getElementById('modal-conn-word').value = '';
            connectModal.classList.remove('hidden');
            document.getElementById('modal-conn-word').focus();
        };

        window.closeConnectModal = () => {
            connectModal.classList.add('hidden');
            currentEditingId = null;
        };

        window.saveNewConnection = () => {
            if (!currentEditingId) return;
            
            const wordInput = document.getElementById('modal-conn-word');
            const typeInput = document.getElementById('modal-conn-type');
            const targetWordText = wordInput.value.trim();
            const type = typeInput.value;

            if (!targetWordText) {
                showAlert("Please enter a word to connect.");
                return;
            }

            const exists = vocabList.some(w => w.word.toLowerCase() === targetWordText.toLowerCase());
            if (!exists) {
                showAlert(`"${targetWordText}" is not in your vocabulary list yet. Please add it first.`);
                return;
            }

            const sourceIndex = vocabList.findIndex(w => w.id === currentEditingId);
            if (sourceIndex !== -1) {
                const sourceWord = vocabList[sourceIndex];

                if (!sourceWord.connections) sourceWord.connections = [];
                sourceWord.connections.push({ word: targetWordText, type: type });

                const targetIndex = vocabList.findIndex(w => w.word.toLowerCase() === targetWordText.toLowerCase());
                if (targetIndex !== -1) {
                    const targetEntry = vocabList[targetIndex];
                    if (!targetEntry.connections) targetEntry.connections = [];

                    let reverseType = 'Related';
                    if (type === 'Synonym') reverseType = 'Synonym';
                    if (type === 'Antonym') reverseType = 'Antonym';
                    if (type === 'Related') reverseType = 'Related';

                    if (!targetEntry.connections.some(c => c.word.toLowerCase() === sourceWord.word.toLowerCase())) {
                        targetEntry.connections.push({
                            word: sourceWord.word,
                            type: reverseType
                        });
                    }
                }

                saveData();
                renderList(vocabList);
                closeConnectModal();
                showToast(`Connected "${sourceWord.word}" ↔ "${targetWordText}"`);
            }
        };

        connectModal.addEventListener('click', (e) => {
            if (e.target === connectModal) closeConnectModal();
        });

        window.searchFor = (word) => {
            switchTab('list');
            searchInput.value = word;
            filterWords();
        };

        // --- Create Word ---
        form.addEventListener('submit', (e) => {
            e.preventDefault();

            const newWordText = document.getElementById('word').value.trim();

            // Check for Duplicate (Case-insensitive)
            const exists = vocabList.some(w => w.word.toLowerCase() === newWordText.toLowerCase());
            if (exists) {
                showAlert(`"${newWordText}" is already in your vocabulary list.`);
                return;
            }

            // Validate at least one part of speech is selected
            if (selectedPositions.add.length === 0) {
                showAlert('Please select at least one part of speech.');
                return;
            }

            const newWord = {
                id: Date.now(),
                word: newWordText,
                pos: [...selectedPositions.add], // Store as array
                meaning: document.getElementById('meaning').value.trim(),
                sentence: document.getElementById('sentence').value.trim(),
                connections: [...currentConnections],
                tags: document.getElementById('tags').value.split(',').map(t => t.trim()).filter(t => t),
                dateAdded: new Date().toLocaleDateString(),
                mastery: 0 // New Field for Practice Mode
            };

            if (newWord.connections && newWord.connections.length > 0) {
                newWord.connections.forEach(conn => {
                    const targetIndex = vocabList.findIndex(w => w.word.toLowerCase() === conn.word.toLowerCase());
                    
                    if (targetIndex !== -1) {
                        const targetEntry = vocabList[targetIndex];
                        if (!targetEntry.connections) targetEntry.connections = [];

                        let reverseType = 'Related';
                        if (conn.type === 'Synonym') reverseType = 'Synonym';
                        if (conn.type === 'Antonym') reverseType = 'Antonym';
                        if (conn.type === 'Related') reverseType = 'Related';

                        targetEntry.connections.push({
                            word: newWordText,
                            type: reverseType
                        });
                    }
                });
            }

            vocabList.unshift(newWord);
            saveData();
            
            form.reset();
            currentConnections = [];
            clearPosSelection('add');
            renderPendingConnections();
            updateDatalist();

            renderList(vocabList);
            showToast(`Added "${newWord.word}" successfully!`);
            
            if(window.innerWidth < 640) {
                switchTab('list');
            }
        });

        function filterWords() {
            const term = searchInput.value.toLowerCase();
            const posFilter = filterPos.value;
            const tagFilter = filterTag.value;
            const sortVal = sortOrder.value;

            // 1. Filter
            const filtered = vocabList.filter(item => {
                const matchesTerm = 
                    item.word.toLowerCase().includes(term) || 
                    item.meaning.toLowerCase().includes(term) ||
                    item.tags.some(tag => tag.toLowerCase().includes(term)) ||
                    (item.connections && item.connections.some(c => c.word.toLowerCase().includes(term)));
                
                const posArray = Array.isArray(item.pos) ? item.pos : [item.pos];
                const matchesPos = posFilter === 'all' || posArray.includes(posFilter);
                const matchesTag = tagFilter === 'all' || item.tags.includes(tagFilter);

                return matchesTerm && matchesPos && matchesTag;
            });

            // 2. Sort
            if (sortVal === 'az') {
                filtered.sort((a, b) => a.word.localeCompare(b.word));
            } else if (sortVal === 'za') {
                filtered.sort((a, b) => b.word.localeCompare(a.word));
            } else if (sortVal === 'oldest') {
                filtered.sort((a, b) => a.id - b.id);
            } else {
                filtered.sort((a, b) => b.id - a.id);
            }

            renderList(filtered);
        }

        searchInput.addEventListener('input', filterWords);
        filterPos.addEventListener('change', filterWords);
        filterTag.addEventListener('change', filterWords);

        // --- Delete Word ---
        window.deleteWord = (id) => {
            const targetId = String(id);
            
            showConfirm('Are you sure you want to delete this word?', () => {
                vocabList = vocabList.filter(w => String(w.id) !== targetId);
                saveData();
                updateDatalist();
                filterWords();
                updateTagFilterOptions();
                showToast('Word deleted');
            });
        };

        window.speakWord = (text) => {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                window.speechSynthesis.speak(utterance);
            } else {
                showToast('Text-to-speech not supported');
            }
        };

        window.copyWord = (text) => {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showToast('Word copied');
            } catch (err) {
                console.error('Unable to copy', err);
            }
            document.body.removeChild(textArea);
        };

        window.clearAll = () => {
            showConfirm('Are you sure you want to delete ALL words? This cannot be undone.', () => {
                vocabList = [];
                saveData();
                renderList(vocabList);
                updateDatalist();
                showToast('All data cleared');
            });
        }

        function saveData() {
            localStorage.setItem('vocabList', JSON.stringify(vocabList));
            updateCount();
            updateTagFilterOptions();
            updatePracticeFilter();
        }

        function updateCount() {
            wordCountSpan.textContent = vocabList.length;
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(vocabList, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "my_vocab_list.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        };

        function showToast(message) {
            toastMsg.textContent = message;
            toast.classList.remove('translate-x-full', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
            }, 3000);
        }

        function renderList(list) {
            listContainer.innerHTML = '';
            
            if (list.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            emptyState.classList.add('hidden');

            list.forEach(item => {
                const posArray = Array.isArray(item.pos) ? item.pos : [item.pos];
                const posHtml = posArray.map(pos => {
                    const posClass = posColors[pos] || posColors['default'];
                    return `<span class="shrink-0 px-2.5 py-0.5 rounded-full text-xs font-semibold border ${posClass}">${pos}</span>`;
                }).join('');
                
                const tags = item.tags || [];
                const tagsHtml = tags.length > 0 
                    ? `<div class="flex flex-wrap gap-2 mt-3 pt-3 border-t border-gray-50 pointer-events-none">
                        ${tags.map(tag => `<span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-full">#${tag}</span>`).join('')}
                       </div>` 
                    : '';

                const sentenceHtml = item.sentence 
                    ? `<div class="bg-indigo-50 p-3 rounded-lg mt-3 text-sm text-indigo-900 italic border-l-2 border-indigo-300">
                         "${item.sentence}"
                       </div>` 
                    : '';
                
                const connections = item.connections || [];
                const connectionsHtml = connections.length > 0
                    ? `<div class="flex flex-wrap gap-2 mt-3 pt-3 border-t border-gray-100">
                        <span class="text-xs text-gray-400 font-medium self-center mr-1">See also:</span>
                        ${connections.map(c => `
                            <button onclick="event.stopPropagation(); searchFor('${c.word}')" class="inline-flex items-center gap-1 px-2 py-1 rounded-md text-xs font-medium bg-gray-100 text-gray-600 hover:bg-indigo-100 hover:text-indigo-700 transition-colors border border-gray-200">
                                <i class="fas fa-link text-[10px]"></i> ${c.word} <span class="opacity-60 font-normal">(${c.type})</span>
                            </button>
                        `).join('')}
                       </div>`
                    : '';

                // NEW: Mastery Visuals (5-segment bar)
                const mastery = item.mastery || 0;
                const bars = [1,2,3,4,5].map(i => {
                    let colorClass = 'bg-gray-200';
                    if (i <= mastery) {
                        if(mastery >= 4) colorClass = 'bg-green-500';
                        else if(mastery >= 2) colorClass = 'bg-yellow-400';
                        else colorClass = 'bg-orange-400';
                    }
                    return `<div class="h-1 w-4 rounded-full ${colorClass}"></div>`;
                }).join('');

                const card = document.createElement('div');
                card.setAttribute('onclick', `openDetailModal(${item.id})`);
                card.className = 'bg-white rounded-xl p-5 sm:p-6 shadow-sm border border-gray-100 card-hover fade-in relative group cursor-pointer';
                
                card.innerHTML = `
                    <div class="absolute top-4 right-4 opacity-100 lg:opacity-0 lg:group-hover:opacity-100 transition-opacity flex gap-1 sm:gap-2 z-20 bg-white sm:bg-transparent rounded-lg p-1 sm:p-0 shadow-sm sm:shadow-none border sm:border-0 border-gray-100">
                        <button onclick="event.stopPropagation(); speakWord('${item.word.replace(/'/g, "\\'")}')" class="p-2 text-gray-400 hover:text-green-600 hover:bg-green-50 rounded-full focus:outline-none focus:ring-2 focus:ring-green-200" title="Listen">
                            <i class="fas fa-volume-up"></i>
                        </button>
                        <button onclick="event.stopPropagation(); openEditModal(${item.id})" class="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-200" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="event.stopPropagation(); openConnectModal(${item.id})" class="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-200" title="Add Connection">
                            <i class="fas fa-link"></i>
                        </button>
                        <button onclick="event.stopPropagation(); copyWord('${item.word.replace(/'/g, "\\'")}')" class="p-2 text-gray-400 hover:text-indigo-600 hover:bg-gray-50 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-200" title="Copy">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button onclick="event.stopPropagation(); deleteWord('${item.id}')" class="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full focus:outline-none focus:ring-2 focus:ring-red-200" title="Delete">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>

                    <div class="flex flex-col gap-1 mb-1 pr-32 sm:pr-36">
                        <div class="flex gap-1 mb-1" title="Mastery Level: ${mastery}/5">
                            ${bars}
                        </div>
                        <div class="flex items-baseline gap-3 flex-wrap">
                            <h3 class="text-xl sm:text-2xl font-bold text-gray-900 font-serif-display tracking-wide break-words">${item.word}</h3>
                            <div class="flex flex-wrap gap-1">
                                ${posHtml}
                            </div>
                        </div>
                    </div>

                    <p class="text-gray-600 mt-2 leading-relaxed text-sm sm:text-base">${item.meaning}</p>
                    
                    ${connectionsHtml}
                    ${sentenceHtml}
                    ${tagsHtml}
                `;
                listContainer.appendChild(card);
            });
            
            updateCount();
        }

        // --- Auto Definition / Translation Logic ---
        
        let preferredLang = localStorage.getItem('preferredLang') || 'en_US';
        
        const settingsLangSelect = document.getElementById('settings-lang');
        if(settingsLangSelect) {
            settingsLangSelect.value = preferredLang;
        }

        window.saveLanguageSetting = () => {
            preferredLang = document.getElementById('settings-lang').value;
            localStorage.setItem('preferredLang', preferredLang);
            showToast(`Language set to ${document.getElementById('settings-lang').options[document.getElementById('settings-lang').selectedIndex].text}`);
        };

        window.fetchDefinition = async () => {
            const wordInput = document.getElementById('word');
            const word = wordInput.value.trim();
            const btn = document.getElementById('auto-btn');
            const icon = btn.querySelector('i');

            if (!word) {
                showAlert('Please type a word first.');
                return;
            }

            const originalIcon = icon.className;
            icon.className = 'fas fa-spinner fa-spin';
            btn.disabled = true;
            btn.classList.add('opacity-75', 'cursor-not-allowed');

            try {
                const dictResponse = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
                
                if (!dictResponse.ok) throw new Error('Word not found');
                
                const data = await dictResponse.json();
                const entry = data[0];
                if (!entry.meanings || entry.meanings.length === 0) throw new Error('No definition found');

                const meanings = entry.meanings[0].definitions;
                let potentialDefs = meanings.slice(0, 3).map(d => d.definition);
                let definition = potentialDefs.reduce((a, b) => a.length <= b.length ? a : b);

                let sentence = entry.meanings[0].definitions[0].example || "";
                
                const apiPos = entry.meanings[0].partOfSpeech; 
                const mappedPos = mapPosToApp(apiPos);

                if (preferredLang !== 'en_US') {
                    const langCode = preferredLang;
                    
                    const transResponse = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(definition)}&langpair=en|${langCode}`);
                    const transData = await transResponse.json();
                    
                    if (transData.responseData && transData.responseData.translatedText) {
                        definition = transData.responseData.translatedText;
                    }
                }

                document.getElementById('meaning').value = definition;
                if(sentence) document.getElementById('sentence').value = sentence;

                if (mappedPos) {
                    clearPosSelection('add');
                    togglePosSelection(mappedPos, 'add');
                }

                showToast('Definition fetched!');

            } catch (error) {
                console.error(error);
                showAlert('Could not find definition. Please ensure spelling is correct (English words only).');
            } finally {
                icon.className = originalIcon;
                btn.disabled = false;
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        };

        function mapPosToApp(apiPos) {
            const map = {
                'noun': 'Noun',
                'verb': 'Verb',
                'adjective': 'Adjective',
                'adverb': 'Adverb',
                'preposition': 'Preposition',
                'conjunction': 'Conjunction'
            };
            return map[apiPos.toLowerCase()] || null;
        }
    </script>
</body>
</html>
